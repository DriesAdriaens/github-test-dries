---
title: "Dataset validatie overstromingen - Mombeek"
author: "Dries Adriaens"
date: "05-01-2020"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 4
    number_sections: yes
    fig_width: 8
    fig_height: 5.7
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(watina)
library(ggplot2)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(sf)
library(leaflet)
library(wateRinfo)
```

```{r connection}
watina <- connect_watina()
```

# Doelstelling

Voor het project Future Floodplains worden de overstromingen in de alluviale vallei van de Mombeek gemodelleerd (werkpakket 1, KULeuven). Voor de validatie van de overstromingskaarten voor de actuele toestand is er nood aan effectief gemeten waterstanden tijdens overstromingen. De vraag is of er op basis van de grondwatermeetpunten (en evt. oppervlaktewatermeetpunten) uit de WATINA databank dergelijke meetgegevens op een betrouwbare manier aangeleverd kunnen worden.

Onderstaand document verkent welke gegevens eventueel in aanmerking komen als dataset ter validatie van de overstromingskaarten, en welke niet.

# Aanpak

* selectie grondwatermeetpunten
* kijken of meetwaarden effectief overeenstemmen met reële waterpeilen boven maaiveld
  + gebruik maken van manuele metingen met specifieke labels (zgn. peilmetingcategorieën) die wijzen op effectieve overstromingen
  + uitsluiten van diepere peilbuizen waar een eventuele kweldruk tot peilen boven maaiveld kan leiden die niet overeenstemmen met waterpeilen tijdens overstromingen
  + checken van locatie van peilbuizen; bv. meer kans op kweldruk aan de steilrand van de vallei
* desgevallend groeperen van meetpunten in relevante raaien, veelal dwars georiënteerd op vallei
* eventueel relatie bekijken met aanwezige peilmetingen van oppervlaktewater (peilschalen) die kan wijzen op effectieve overstromingen ter hoogte van peilbuizen, waardoor er meer kans is dat de gemeten stijghoogten overeenstemmen met de waterpeilen in de overstroomde zones

# Meetpunten

We vragen de metadata van de grond- en oppervlaktewatermeetpunten in de vallei van de Mombeek op met behulp van het R-package `Watina`.

```{r meetpunten}
locaties <- get_locs(watina,
                     area_codes = "MOM",
                     loc_type = c("P", "B", "S"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_guess = TRUE,
                     filterdepth_na = TRUE,
                     filterdepth_range = c(0, 30)) %>% 
  mutate(loc_nr = as.numeric(substr(loc_code, 6, 7))) %>% 
  filter(loc_typecode %in% c("P", "B") & loc_nr <= 29 |
           loc_typecode == "S" & loc_nr <= 11)
locaties %>% collect() %>% knitr::kable()
```
Histogram op basis van de diepte van de filters van de grondwatermeetpunten (`loc_type %in% c("P", "B")`) :
```{r warning=FALSE, message=FALSE}
locaties %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

De maximale filterdiepte bedraagt 2.94m. Relatief ondiep dus, waardoor hoge kweldrukken minder waarschijnlijk zijn, maar niet uitgesloten.

# Raaien

In de vallei van de Mombeek liggen de meetpunten gegroepeerd in 3 raaien, telkens dwars georiënteerd op de Mombeek. Eén meetpunt ligt geïsoleerd in het oosten.

Onderstaande tabel groepeert de meetpunten per raai.

```{r raaien}
trans_mom_1 <- c("MOMP005", "MOMP006", "MOMP007", "MOMP008", "MOMP009")
trans_mom_2 <- c("MOMP001", "MOMP003", "MOMP004", "MOMP010", "MOMP002",
                 "MOMP011", "MOMP029", "MOMP012", "MOMP013","MOMS001",
                 "MOMS009", "MOMP014",
                 "MOMP015", "MOMP016", "MOMS008", "MOMS002")
trans_mom_3 <- c("MOMP027", "MOMS011", "MOMP026", "MOMP025", "MOMP024",
                 "MOMP023", "MOMS007", "MOMS010", "MOMP017", "MOMP018",
                 "MOMP019", "MOMP020", "MOMP021", "MOMP022")
trans_mom_4 <- c("MOMP028")

locs <- locaties %>% collect()
transects <- data.frame(loc_code = locs$loc_code,
                        transect_nr = 0, stringsAsFactors = FALSE) %>% 
  mutate(transect_nr = ifelse(loc_code %in% trans_mom_1, 1,
                              ifelse(loc_code %in% trans_mom_2, 2,
                                     ifelse(loc_code %in% trans_mom_3, 3,
                                            ifelse(loc_code %in% trans_mom_4, 4,
                                                   transect_nr)))))
transects %>% knitr::kable()

locs <- locaties %>% collect() %>% 
  left_join(transects, by = "loc_code") %>% 
  filter(transect_nr > 0)
```
Overzichtskaartje van de peilbuizen en peilschalen, met aanduiding van de overstromingsgevoelige gebieden (optioneel: recent overstroomde gebieden en de habitatrichtlijngebieden (HRL)):

```{r}
pal <- colorFactor(palette = c("red", "blue"), domain = locs$loc_typecode)
leaflet(data = locs %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Ortho_VL_winter") %>% 
  addWMSTiles("https://inspirepub.waterinfo.be/arcgis/services/Overstromingsgevoelige_gebieden_2017/MapServer/WMSServer?",
              layers = "0",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Overstromingsgevoelig") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/VMM/wms?",
              layers = "RecOvstrGeb",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Recent overstroomd") %>% 
  addWMSTiles("https://www.mercator.vlaanderen.be/raadpleegdienstenmercatorpubliek/ows?SERVICE=WMS",
              layers = "ps:ps_hbtrl_deel",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "HRL") %>% 
  hideGroup(c("Recent overstroomd", "HRL")) %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = ~pal(loc_typecode),
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.50),
             group = "Meetpunten") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Overstromingsgevoelig", "Recent overstroomd", "Meetpunten", "HRL"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(#pal = pal, values = ~loc_typecode,
            colors = c("red", "blue"), labels = c("grondwater", "oppervlaktewater"),
            group = "Meetpunten", title = "Meetpunttype")
```

# Kweldruk

Uit de metadata van de grondwatermeetpunten leiden we af dat er in geen van de raaien peilbuiskoppels aanwezig zijn waarmee we ons een idee kunnen vormen van de eventueel aanwezig kweldruk in een meetpunt. Het gaat dan om twee of meerdere peilbuizen met filters op verschillende diepten (piëzometers).

Stijghoogteverschillen (in mTAW) tussen deze filters op eenzelfde locatie wijzen veelal op een grondwaterstroming (flux) van de ene filter naar de andere. Hoe hoger de druk ter hoogte van de filter, hoe minder de gemeten stijghoogte in een peilbuis overeen zal stemmen met de werkelijke grondwatertafel ter hoogte van het meetpunt. Meestal geldt: hoe dieper de filter, hoe groter de kans op een grotere stijghoogte, en hoe groter de afwijking tussen de stijghoogte en de effectieve grondwatertafel. Die grondwatertafel ligt vaak lager dan de gemeten stijghoogte in een peilbuis doordat het vrij stromende grondwater vaak uittreedt ter hoogte van het maaiveld en afgevoerd wordt via greppels en sloten, of zich onder het maaiveld reeds lateraal verplaatst vooraleer aan de oppervlakte te komen. Bij een hoge kweldruk kan de gemeten stijghoogte dus boven maaiveld liggen, terwijl de grondwatertafel gelijk of onder maaiveld ligt. Door in zo'n geval te veronderstellen dat stijghoogten zonder meer overeenstemmen met de effectieve grondwatertafel, zou men denken dat het maaiveld onder water staat, en er dus sprake is van overstroming, terwijl in realiteit door de aanwezige drainage of laterale grondwaterstroming het effectieve grondwaterpeil helemaal niet boven maaiveld uitkomt. Die vergissing is uiteraard te vermijden als je die metingen (stijghoogten in geval van piëzometers) net wil gebruiken om gemodelleerde overstromingsdiepten te ijken.

Daarom is het belangrijk om meetpunten uit te sluiten waar aangetoond kan worden (in geval van peilbuiskoppel) of er het vermoeden is van een hoge kweldruk. Doordat er geen peilbuiskoppels in de vallei van de Mombeek aanwezig zijn, kunnen we geen uitsluitsel geven over een kweldruk. Daarnaast is de kans het grootst om verhoogde kweldrukken aan te treffen aan de rand van de vallei. Meer naar het centrum van de vallei neemt die kweldruk veelal af. Extra aandacht is dus nodig bij de beoordeling van de metingen van punten aan de rand van de vallei. Hier is de kans het grootst dat gemeten stijghoogten boven maaiveld niet overeenstemmen met effectieve overstromingen.

# Tijdreeksen per raai

Hieronder bespreken we de tijdreeksen per raai. We zetten de gemeten stijghoogten uit relatief ten opzichte van maaiveld, maar ook in absolute hoogte (mTAW). Dat laatste laat toe om ook de gemeten oppervlaktewaterpeilen van de Mombeek en Oude Mombeek mee in de grafieken op te nemen. Op die manier kunnen we relaties tussen grond- en oppervlaktewaterpeilen visueel beoordelen.

De focus ligt op de meetpunten met tijdreeksen waar stijghoogten boven maaiveld liggen. Ter volledigheid nemen we ook de tijdreeksen op van meetpunten met stijghoogten die jaarrond onder maaiveld liggen. 

## Samenstellen van tijdreeksen

We stellen de tijdreeksen voor de verschillende meetpunten samen door alle gevalideerde metingen op te vragen, met uitzondering van de speciale peilmetingcategorieën. We nemen enkel de categorieën "Peilbuis onder water" (SOUWA) en "Peilpunt onder water" (TBWWL) mee in de selectie.

```{r tijdreeks}
tijdreeks <-
  locaties %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"), by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  collect() %>% 
  left_join(transects, by = "loc_code") %>% 
  group_by(loc_code) %>% 
  mutate(gr_mv = ifelse(max(mMaaiveld) > 0 & loc_typecode != "S", 1, 0))
```

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens transect, y-coördinaat, en meetpuntcode:

```{r}
tijdreeks %>%
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

Op basis van de peilmetingen kunnen we de grondwatermeetpunten selecteren waar de stijghoogten ooit boven maaiveld lagen.

```{r}
locs <- locs %>% 
  left_join(tijdreeks %>% 
              filter(gr_mv == 1) %>% 
              select(loc_code, gr_mv) %>%
              distinct(),
            by = "loc_code")
locs %>% filter(gr_mv == 1) %>% 
  select(loc_code, transect_nr) %>%
  arrange(transect_nr, loc_code) %>% 
  knitr::kable()
```

Uit dat lijstje blijkt dat de stijghoogten in de drie westelijk gelegen raaien telkens in meerdere meetpunten tot boven maaiveld reiken.

## Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd. Dergelijke metingen werden in de vallei van de Mombeek echter niet vastgesteld.

We bekijken hieronder de tijdreeksen voor elk van de raaien in meer detail. 

## Raai 1

Dit is de meest westelijk gelegen raai van de Mombeekvallei. De meetpunten liggen net ten oosten van de verbindingsweg tussen Hasselt en Sint-Truiden (N80). De raai vertrekt aan de voet van het voormalige stort aan de zuidrand van de vallei (MOMP005) en eindigt ter hoogte van meetpunt MOMP009 aan de vrij steile, noordoostelijke rand van de vallei. De raai overspant de Oude Mombeek, de Ossengracht en de Mombeek. Net stroomopwaarts de N80 vloeien de Oude Mombeek en de Ossengracht samen met de Kleine Herk. En net stroomafwaarts de N80 mondt de Mombeek uit in de Herk.

De maaiveldhoogte loopt systematisch op van zuidwest naar noordoost.

### Kaart

Grote cirkels voor meetpunten met stijghoogten boven maaiveld.
```{r kaart_raai_1}
pal <- colorFactor(palette = c("red", "blue"), domain = locs$loc_typecode)

leaflet(data = locs %>% 
  filter(transect_nr == 1) %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addWMSTiles("https://inspirepub.waterinfo.be/arcgis/services/Overstromingsgevoelige_gebieden_2017/MapServer/WMSServer?",
              layers = "0",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Overstromingsgevoelig") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/VMM/wms?",
              layers = "RecOvstrGeb",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Recent overstroomd") %>% 
  hideGroup(group = c("Overstromingsgevoelig", "Recent overstroomd")) %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, 
                   color = ~pal(loc_typecode),
                   radius = ~ifelse(is.na(gr_mv), 5, 10),
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.5)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten", "Overstromingsgevoelig", "Recent overstroomd"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(#pal = pal, values = ~loc_typecode,
            colors = c("red", "blue"), labels = c("grondwater", "oppervlaktewater"),
            group = "Meetpunten", title = "Meetpunttype")
```

### Tijdreeksen

In elk van de meetpunten in deze raai bevatten de tijdreeksen stijghoogten boven maaiveld.

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens y-coördinaat:

```{r message=FALSE, warning=FALSE}
tijdreeks %>%
  filter(transect_nr == 1 & loc_typecode == "P") %>% 
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

m-mv

```{r tijdreeks_raai_1, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1 & loc_typecode != "S")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

m-mv, sinds 2017

```{r tijdreeks_raai_1_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1 & loc_typecode != "S")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

```{r message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1 & gr_mv == 1)) +
  geom_hline(yintercept = 0, colour = "black", size = 0.5) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(32.25, 34.25),
  # #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        # legend.position = "bottom"
        ) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

mTAW, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_1_TAW, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_1_TAW_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

```{r message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 1 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(32.25, 34.25),
  # #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = loc_code), linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

Vaststellingen:

* De stijghoogten liggen vooral in de uiterste meetpunten (MOMP005 en MOMP009) van de raai voor langere perioden boven maaiveld. In de overige meetpunten komen de stijghoogten enkel zeer kortstondig boven maaiveld, wellicht enkel op momenten met hoge neerslag in de winterperiode als de waterpeilen van de waterlopen stijgen en ze buiten hun oevers treden
* MOMP005 ligt aan de voet van een stort, op het laagste punt van de raai. Hier is het dan ook waarschijnlijk dat de stijghoogten boven maaiveld overeenstemmen met effectieve overstromingen
* MOMP009 daarentegen ligt aan de voet van de vrij steile, noordoostelijke valleirand, op een 20-tal meter van de Mombeek, maar wel ongeveer 2 meter hoger dan het peil van de Mombeek. Gezien de helling ter hoogte van het meetpunt en de eerder langdurige periode met stijghoogten (net) boven maaiveld is het onwaarschijnlijk dat de stijghoogten boven maaiveld overeenkomen met het peil van overstromingen in de vallei. Bovendien zitten er geen pieken in deze peilen die wijzen op het vaak kortstondig karakter van overstromingen. Het gaat hier dus waarschijnlijk eerder om tijdelijk verhoogde kweldrukken in de winterperiode. De peilen boven maaiveld blijven ook vrij beperkt.

Violin- en boxplot, enkel van metingen boven maaiveld:

```{r message=FALSE, warning=FALSE}
tijdreeks %>% 
  filter(transect_nr == 1 & mMaaiveld > 0) %>% 
  select(loc_code, mMaaiveld) %>% 
  # ggplot() + geom_histogram(aes(mMaaiveld)) %>% 
  ggplot() + geom_violin(aes(x = loc_code, y = mMaaiveld, fill = loc_code),
                         scale = "count",
                         # draw_quantiles = c(0.25, 0.5, 0.75)
                         ) + 
  geom_boxplot(aes(x = loc_code, y = mMaaiveld), fill = NA) +
  geom_text(data = tijdreeks %>%
              filter(transect_nr == 1 & mMaaiveld > 0) %>%
              group_by(loc_code) %>%
              summarise(numb = n()),
            aes(x = loc_code, y = -0.02, label = paste0("n = ", round(numb, 2)))) +
  labs(x = NULL, y = "m-mv [mMaaiveld > 0]")
  
# tijdreeks %>% 
#   filter(loc_code == "MOMP009" & mMaaiveld > 0) %>% 
#   select(loc_code, Datum, mMaaiveld) %>% 
#   arrange(Datum) %>% 
#   knitr::kable()
```

## Raai 2

### Kaart

Grote cirkels voor meetpunten met stijghoogten boven maaiveld. Kleine cirkels voor meetpunten zonder stijghoogten boven maaiveld.

```{r kaart_raai_2}
pal <- colorFactor(palette = c("red", "blue"), domain = locs$loc_typecode)

leaflet(data = locs %>% 
  filter(transect_nr == 2) %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addWMSTiles("https://inspirepub.waterinfo.be/arcgis/services/Overstromingsgevoelige_gebieden_2017/MapServer/WMSServer?",
              layers = "0",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Overstromingsgevoelig") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/VMM/wms?",
              layers = "RecOvstrGeb",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Recent overstroomd") %>% 
  hideGroup(group = c("Overstromingsgevoelig", "Recent overstroomd")) %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, 
                   color = ~pal(loc_typecode),
                   radius = ~ifelse(is.na(gr_mv), 5, 10),
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.5)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten", "Overstromingsgevoelig", "Recent overstroomd"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(#pal = pal, values = ~loc_typecode,
            colors = c("red", "blue"), labels = c("grondwater", "oppervlaktewater"),
            group = "Meetpunten", title = "Meetpunttype")
```

### Tijdreeksen met stijghoogten boven maaiveld

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens y-coördinaat:

```{r message=FALSE, warning=FALSE}
tijdreeks %>%
  filter(transect_nr == 2 & loc_typecode == "P" & gr_mv == 1) %>% 
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

Beperkt tot tijdreeksen met stijghoogten boven maaiveld. Merk op dat in het valleigedeelte tussen Oude Mombeek en Mombeek de stijghoogten niet boven maaiveld uitkomen. Dat is enkel het geval in de meetpunten ten zuiden van de Oude Mombeek.

m-mv

```{r tijdreeks_raai_2, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

m-mv, sinds 2017

```{r tijdreeks_raai_2_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2
                & gr_mv == 1
                )) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
# ggsave("mom_raai2_mmv_single.jpg", width = 42, height = 30, units = "cm", dpi = 300, scale = 0.75)
```
```{r tijdreeks_raai_2_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(loc_code %in% c(
           "MOMP001", "MOMP002", "MOMP011", "MOMP012", "MOMP014", "MOMP015", "MOMP016"
         )
         )) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 0.5,
             # linetype = "dotted"
             ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(size = 0.5, linetype = "dashed"),
        panel.grid.major.x = element_line(size = 0.75),
        text = element_text(size = 20)) +
  scale_x_date(date_breaks = "year",
               date_labels = "%Y",
               date_minor_breaks = "3 months",
               limits = c(ymd("2017-01-01"), ymd("2022-05-01")),
               expand = c(0,0)
  ) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
ggsave("mombeek_raai2_tijdreeks_mmv_single.pdf", width = 42, height = 30, units = "cm", dpi = 300)
```

```{r message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_hline(yintercept = 0, colour = "black", size = 0.5) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(32.25, 34.25),
  # #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        # legend.position = "bottom"
        ) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
# ggsave("mom_raai2_mmv.jpg", width = 16, height = 16, units = "cm", dpi = 300)
```

mTAW, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_2_TAW, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.5),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_2_TAW_2017_1, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(32.25, 34.25),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

```{r message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.25),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = loc_code), linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
# ggsave("mom_raai2_taw.jpg", width = 16, height = 16, units = "cm", dpi = 300)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn. De tijdreeksen van de waterpeilen van de Mombeek staan in het grijs.

```{r tijdreeks_raai_2_TAW_2017_2, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.75),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  geom_line(data = tijdreeks %>% filter(transect_nr == 2 & loc_code %in% c("MOMS002", "MOMS008")),
            aes(x = date(Datum),
                y = mTAW,
                group = loc_code, linetype = loc_code),
            alpha = 0.25) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = "Mombeek")
```

```{r message=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = tijdreeks %>% as.data.frame() %>% filter(transect_nr == 2 &
                                                              loc_code %in% c("MOMS008", "MOMS002")) %>% 
              select(-loc_code),
            aes(x = date(Datum),
                y = mTAW, linetype = "Mombeek"),
            alpha = 0.25) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 2 & gr_mv == 1),
            aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.25),
                  # xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 2 & gr_mv == 1),
            aes(x = date(Datum),
                y = mvTAW,
                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))
                colour = loc_code),
            linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "horizontal",
        legend.direction = "horizontal") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
# ggsave("mom_ps_raai2.jpg", width = 16, height = 16, units = "cm", dpi = 300)
```

Hieruit blijkt dat de grondwaterpeilen vooral in het voorjaar sterk reageren op peilmaxima in de Mombeek.

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn. De tijdreeksen van de waterpeilen van de Oude Mombeek staan in het grijs.

```{r tijdreeks_raai_2_TAW_2017_3, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.75),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  geom_line(data = tijdreeks %>% filter(transect_nr == 2 & loc_code %in% c("MOMS009")),
            aes(x = date(Datum),
                y = mTAW,
                # linetype = loc_code
                group = loc_code, linetype = loc_code),
            alpha = 0.25) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = "Oude Mombeek")
```

```{r message=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = tijdreeks %>%
              as.data.frame() %>%
              filter(transect_nr == 2 &
                       loc_code %in% c("MOMS009")) %>% 
              select(-loc_code),
            aes(x = date(Datum),
                y = mTAW, linetype = "Oude Mombeek"),
            alpha = 0.25) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 2 & gr_mv == 1),
            aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.25),
                  # xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 2 & gr_mv == 1),
            aes(x = date(Datum),
                y = mvTAW,
                colour = loc_code),
            linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "horizontal",
        legend.direction = "horizontal") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
# ggsave("mom_ps_oudemombeek_raai2.jpg", width = 16, height = 16, units = "cm", dpi = 300)
```

Vaststellingen:

* In het na- en voorjaar liggen de stijghoogten in de grondwatermeetpunten boven het waterpeil van zowel Mombeek als Oude Mombeek. In die periode werken beide waterlopen dus drainerend op de omliggende valleigronden.
* In de zomerperiode zakken de stijghoogten onder het waterpeil van de Mombeek, en onder het bodempeil van de Oude Mombeek
* De Oude Mombeek valt elk jaar in de zomerperiode een hele tijd droog; helaas zijn er geen meetgegevens om te bekijken hoe uitzonderlijk droog de meetperiode was in vergelijking met voorgaande jaren

Violin- en boxplot, enkel van metingen boven maaiveld:

```{r message=FALSE, warning=FALSE}
tijdreeks %>% 
  filter(transect_nr == 2 & mMaaiveld > 0 & loc_typecode != "S") %>% 
  select(loc_code, mMaaiveld) %>% 
  # ggplot() + geom_histogram(aes(mMaaiveld)) %>% 
  ggplot() + geom_violin(aes(x = loc_code, y = mMaaiveld, fill = loc_code),
                         scale = "count",
                         # draw_quantiles = c(0.25, 0.5, 0.75)
                         ) + 
  geom_boxplot(aes(x = loc_code, y = mMaaiveld), fill = NA) +
  geom_text(data = tijdreeks %>%
              filter(transect_nr == 2 & mMaaiveld > 0 & loc_typecode != "S") %>%
              group_by(loc_code) %>%
              summarise(numb = n()),
            aes(x = loc_code, y = -0.02, label = paste0("n = ", round(numb, 2)))) +
  labs(x = NULL, y = "m-mv [mMaaiveld > 0]")
  
# tijdreeks %>% 
#   filter(loc_code == "MOMP009" & mMaaiveld > 0) %>% 
#   select(loc_code, Datum, mMaaiveld) %>% 
#   arrange(Datum) %>% 
#   knitr::kable()
```

Figuur met enkel de peilschalen van raai 2 (MOMS001 en MOMS009: Oude Mombeek; MOMS002 en MOMS008: Mombeek):

```{r tijdreeks_raai_2_TAW_2017_4, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & loc_typecode == "S")) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(32.25, 34.75),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2021-01-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)

```

De peilen in de Oude Mombeek liggen lager dan die van de Mombeek. De peilen in de Oude Mombeek kennen een amplitude van ongeveer 1 meter, met de hoogste peilen uiteraard in het na- en voorjaar. In de zomerperiode valt de Oude Mombeek droog, de Mombeek niet. In de zomer ligt het peil van de Mombeek ongeveer een halve meter boven het bodempeil van de Oude Mombeek. Beide waterlopen kennen uitgesproken pieken in de peilen in respons op neerslag.

Hieronder bekijken we ter informatie ook nog de tijdreeksen van de peilen van de Mombeek en de Oude Mombeek ter hoogte van de Luikersteenweg (N20), halverwege raai 2 en 3. Deze metingen zijn beschikbaar via waterinfo.be. Het gaat resp. om de meetstations L09_167 en L09_16G. Deze tijdreeksen beslaan een langere meetperiode (2013-2020). Beide meetstations liggen ongeveer 1200 m stroomopwaarts van meetraai 2. 

```{r}
# supported_variables("nl")

get_stations(variable_name = "waterstand") %>%
  filter(grepl("Mombeek", station_name)) %>%
  arrange(station_no) %>%
  knitr::kable()

```

Verifiëren van de ligging van het betreffende meetstations:

```{r}

leaflet(get_stations(variable_name = "waterstand") %>%
          filter(grepl("Mombeek", station_name)) %>%
          st_as_sf(coords = c("station_longitude", "station_latitude"))) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>%
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>%
  addCircleMarkers(
    label = ~paste0(station_name, "\n", station_no), fill = FALSE, weight = 3,
    color = "red", opacity = 1,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.75),
    group = "Meetstations") %>%
  addCircleMarkers(data = locs %>% 
                     filter(transect_nr == 2 & loc_typecode == "S") %>% 
                     st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
                     st_transform(crs = 4326),
                   label = ~loc_code, fill = FALSE, weight = 3,
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75),
                   group = "Peilschalen raai 2") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>%
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetstations", "Peilschalen raai 2"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Opvragen van de waterstandsvariabelen die opgemeten of berekend worden voor dit meetstation:

```{r message=FALSE}
get_variables("L09_167") %>%
  filter(parametertype_name == "H") %>%
  knitr::kable()
```
Omdat de grondwatermetingen ook een tijdsresolutie van een halve dag hebben (indien sondemetingen althans), en de maximale waarde wellicht het meest bepalend is voor de grondwaterstanden, kiezen we hier voor "DagMax". Dat levert voor meetstation L09_167 (Mombeek) en L09_16G (Oude Mombeek) resp. `ts_id = 4874042` en `ts_id = 4984042` op. Op basis van deze id's vragen we de tijdreeksen op tussen 2000 en 2020.

Tijdreeks:

```{r message=FALSE}
ggplot() +
  geom_line(data = get_timeseries_tsid("4874042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_167_Mombeek"), alpha = 0.5) +
  geom_line(data = get_timeseries_tsid("4984042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_16G_Oude_Mombeek"), alpha = 0.5) +
  # geom_line(data = get_locs(watina, loc_vec = c("DYLS102"), loc_type = c("S")) %>%
  #             inner_join(tbl(watina, "FactPeilMeting"),
  #                        by = c("loc_wid" = "MeetpuntWID")) %>%
  #             filter(PeilmetingStatusCode == "VLD") %>%
  #             inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")),
  #           aes(x = date(Datum),
  #               y = mTAW, colour = "DYLS102"), alpha = 0.5) +
  # coord_cartesian(xlim = c(ymd("2015-01-01"), ymd("2016-01-01"))) +
  labs(colour = NULL, x = "Datum", y = "Maximaal dagpeil (mTAW)") +
  theme(legend.position = "bottom")
```

We bekijken deze meetreeksen samen met de meetreeksen uit WATINA:

```{r message=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = get_timeseries_tsid("4874042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_167_Mombeek"), alpha = 0.5) +
  geom_line(data = get_timeseries_tsid("4984042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_16G_Oude_Mombeek"), alpha = 0.5) +
  geom_line(data = tijdreeks %>% 
         filter(transect_nr == 2 & loc_typecode == "S"),
         aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  labs(colour = NULL, x = "Datum", y = "Peil (mTAW)") +
  theme(legend.position = "bottom")
```

Enkel voor metingen sinds 2012:

```{r message=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = get_timeseries_tsid("4874042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_167_Mombeek"), alpha = 0.5) +
  geom_line(data = get_timeseries_tsid("4984042", from = "2000-01-01"),
            aes(date(ymd_hms(Timestamp)), Value, colour = "L09_16G_Oude_Mombeek"), alpha = 0.5) +
  geom_line(data = tijdreeks %>% 
         filter(transect_nr == 2 & loc_typecode == "S"),
         aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  xlim(c(ymd("2012-01-01"), ymd("2021-01-01"))) +
  ylim(c(32.5, 36)) +
  labs(colour = NULL, x = "Datum", y = "Peil (mTAW)") +
  theme(legend.position = "bottom")
ggsave("Mom_peilschalen.jpg", width = 16, height = 10, dpi = 300, units = "cm")
```

Hieruit maken we op dat:

* Ter hoogte van de meetstations van waterinfo.be liggen de peilen van de Mombeek lager dan die van de Oude Mombeek. In meetraai 2, dus ongeveer 1 km stroomafwaarts, is dat net omgekeerd. In meetraai 2 is het peilverschil tussen beide ook groter (ongeveer 0.5 m)
* Ter hoogte van de meetstations lijkt de Oude Mombeek niet echt droog te vallen, terwijl dat wel het geval is in raai 2, met name dan in de zomerperiode
* de peilen in beide waterlopen een vrij gelijkaardig verloop kennen in elk van de 8 afgelopen jaren

### Tijdreeksen met enkel stijghoogten onder maaiveld

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens y-coördinaat:

```{r message=FALSE, warning=FALSE}
tijdreeks %>%
  filter(transect_nr == 2 & loc_typecode == "P" & gr_mv == 0) %>% 
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn, enkel de meetpunten met stijghoogten die niet boven maaiveld uitkomen

```{r warning=FALSE, message=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & loc_typecode == "P" & gr_mv == 0)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.25),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn, enkel de meetpunten met stijghoogten die niet boven maaiveld uitkomen

```{r warning=FALSE, message=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 2 & loc_typecode == "P" & gr_mv == 0)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(31.5, 34.25),
                  xlim = c(ymd("2017-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

## Raai 3

### Kaart

Grote cirkels voor meetpunten met stijghoogten boven maaiveld. Kleine cirkels voor meetpunten zonder stijghoogten boven maaiveld.

```{r kaart_raai_3}
pal <- colorFactor(palette = c("red", "blue"), domain = locs$loc_typecode)

leaflet(data = locs %>% 
  filter(transect_nr == 3) %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addWMSTiles("https://inspirepub.waterinfo.be/arcgis/services/Overstromingsgevoelige_gebieden_2017/MapServer/WMSServer?",
              layers = "0",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Overstromingsgevoelig") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/VMM/wms?",
              layers = "RecOvstrGeb",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Recent overstroomd") %>% 
  hideGroup(group = c("Overstromingsgevoelig", "Recent overstroomd")) %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, 
                   color = ~pal(loc_typecode),
                   radius = ~ifelse(is.na(gr_mv), 5, 10),
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.5)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten", "Overstromingsgevoelig", "Recent overstroomd"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(#pal = pal, values = ~loc_typecode,
            colors = c("red", "blue"), labels = c("grondwater", "oppervlaktewater"),
            group = "Meetpunten", title = "Meetpunttype")
```

### Tijdreeksen met stijghoogten boven maaiveld

Beperkt tot tijdreeksen met stijghoogten boven maaiveld

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens y-coördinaat:

```{r message=FALSE, warning=FALSE}
tijdreeks %>%
  filter(transect_nr == 3 & loc_typecode == "P" & gr_mv == 1) %>% 
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

m-mv

```{r tijdreeks_raai_3, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & loc_typecode != "S" & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

m-mv, sinds 2017

```{r tijdreeks_raai_3_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & loc_typecode != "S" & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(#ylim = c(-1, 0.1),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

```{r message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_hline(yintercept = 0, colour = "black", size = 0.5) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(32.25, 34.25),
  # #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        # legend.position = "bottom"
        ) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

mTAW, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_3_TAW, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34, 37.5),
  #                 xlim = c(ymd("2018-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_3_TAW_2017, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34, 37.5),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

```{r message=FALSE, warning=FALSE, fig.height=10}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34.40, 37.20),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2021-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
                colour = loc_code), linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn. De tijdreeksen van de waterpeilen van de Mombeek staan in het grijs.

```{r tijdreeks_raai_3_TAW_2017_2, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34.40, 37.20),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2021-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  geom_line(data = tijdreeks %>% filter(transect_nr == 3 & loc_code %in% c("MOMS010")),
            aes(x = date(Datum),
                y = mTAW,
                # linetype = loc_code
                group = loc_code, linetype = loc_code),
            alpha = 0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = "Mombeek")
```

```{r message=FALSE, warning=FALSE, fig.height=10}
ggplot() +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 3 & gr_mv == 1),
            aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  geom_line(data = tijdreeks %>% as.data.frame() %>% filter(transect_nr == 3 &
                                                              loc_code %in% c("MOMS010")) %>% 
              select(-loc_code),
            aes(x = date(Datum),
                y = mTAW, linetype = "Mombeek"),
            alpha = 0.25) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34.40, 37.20),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 3 & gr_mv == 1),
            aes(x = date(Datum),
                y = mvTAW,
                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))
                colour = loc_code),
            linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "horizontal",
        legend.direction = "horizontal") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn. De tijdreeksen van de waterpeilen van de Oude Mombeek staan in het grijs.

```{r tijdreeks_raai_3_TAW_2017_3, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & gr_mv == 1)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34.40, 37.20),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  geom_line(data = tijdreeks %>% filter(transect_nr == 3 & loc_code %in% c("MOMS011")),
            aes(x = date(Datum),
                y = mTAW,
                # linetype = loc_code
                # group = loc_code,
                linetype = loc_code),
            alpha = 0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = "Oude Mombeek")
```

```{r message=FALSE, warning=FALSE, fig.height=10}
ggplot() +
  geom_line(data = tijdreeks %>% as.data.frame() %>% filter(transect_nr == 3 &
                                                              loc_code %in% c("MOMS011")) %>% 
              select(-loc_code),
            aes(x = date(Datum),
                y = mTAW, linetype = "Oude Mombeek"),
            alpha = 0.25) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 3 & gr_mv == 1),
            aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
   coord_cartesian(ylim = c(34.40, 37.20),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2021-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(data = tijdreeks %>% 
              filter(transect_nr == 3 & gr_mv == 1),
            aes(x = date(Datum),
                y = mvTAW,
                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))
                colour = loc_code),
            linetype = "dashed") +
  facet_wrap(~loc_code) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "horizontal",
        legend.direction = "horizontal") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```

Violin- en boxplot, enkel van metingen boven maaiveld:

```{r message=FALSE, warning=FALSE}
tijdreeks %>% 
  filter(transect_nr == 3 & mMaaiveld > 0 & loc_typecode != "S") %>% 
  select(loc_code, mMaaiveld) %>% 
  # ggplot() + geom_histogram(aes(mMaaiveld)) %>% 
  ggplot() +
  geom_violin(aes(x = loc_code, y = mMaaiveld, fill = loc_code),
              scale = "count",
              # draw_quantiles = c(0.25, 0.5, 0.75)
  ) + 
  geom_boxplot(aes(x = loc_code, y = mMaaiveld), fill = NA) +
  geom_text(data = tijdreeks %>%
              filter(transect_nr == 3 & mMaaiveld > 0 & loc_typecode != "S") %>%
              group_by(loc_code) %>%
              summarise(numb = n()),
            aes(x = loc_code, y = -0.02, label = paste0("n = ", round(numb, 2)))) +
  labs(x = NULL, y = "m-mv [mMaaiveld > 0]")
  
# tijdreeks %>% 
#   filter(loc_code == "MOMP009" & mMaaiveld > 0) %>% 
#   select(loc_code, Datum, mMaaiveld) %>% 
#   arrange(Datum) %>% 
#   knitr::kable()
```

Enkel de peilschalen van raai 3 (MOMS011: Oude Mombeek; MOMS010: Mombeek):
```{r tijdreeks_raai_3_TAW_2017_4, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & loc_typecode == "S")) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(32.25, 34.75),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  # ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  xlim(ymd("2017-01-01"), ymd("2022-03-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

Voor langere tijdreeksen van Mombeek en Oude Mombeek verwijzen we naar de reeksen voor de meetstations van waterinfo.be zoals besproken onder raai 2.

### Tijdreeksen met enkel stijghoogten onder maaiveld

Tabel met kenmerken van de metingen per meetpunt (resp. begin- en einddatum, aantal metingen, aantal en procentueel aandeel van metingen met stijghoogten boven maaiveld); gesorteerd volgens y-coördinaat:

```{r message=FALSE, warning=FALSE}
tijdreeks %>%
  filter(transect_nr == 3 & loc_typecode == "P" & gr_mv == 0) %>% 
  mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>% 
  group_by(loc_code) %>% 
  summarise(transect = min(transect_nr),
            Date_first = min(Datum),
            Date_last = max(Datum),
            n = n(),
            n_gr_mv = sum(gr_mv_),
            y = min(y)) %>% 
  mutate(pc_gr_mv = round(n_gr_mv/n*100, 1)) %>% 
  arrange(transect, y, loc_code) %>% 
  select(-y) %>% 
  knitr::kable()
```

mTAW, met telkens de aanduiding van de maaiveldhoogte in stippellijn, enkel de meetpunten met stijghoogten die niet boven maaiveld uitkomen

```{r warning=FALSE, message=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & loc_typecode == "P" & gr_mv == 0)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34, 37.5),
  #                 xlim = c(ymd("2018-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

mTAW, sinds 2017, met telkens de aanduiding van de maaiveldhoogte in stippellijn, enkel de meetpunten met stijghoogten die niet boven maaiveld uitkomen

```{r warning=FALSE, message=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 3 & loc_typecode == "P" & gr_mv == 0)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(34.5, 37.5),
                  xlim = c(ymd("2017-01-01"), ymd("2022-03-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

## Raai 4

### Kaart

Grote cirkels voor meetpunten met stijghoogten boven maaiveld. Kleine cirkels voor meetpunten zonder stijghoogten boven maaiveld.

```{r kaart_raai_4}
pal <- colorFactor(palette = c("red", "blue"), domain = locs$loc_typecode)

leaflet(data = locs %>% 
  filter(transect_nr == 4) %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addWMSTiles("https://inspirepub.waterinfo.be/arcgis/services/Overstromingsgevoelige_gebieden_2017/MapServer/WMSServer?",
              layers = "0",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Overstromingsgevoelig") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/VMM/wms?",
              layers = "RecOvstrGeb",
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 0.5),
              group = "Recent overstroomd") %>% 
  hideGroup(group = c("Overstromingsgevoelig", "Recent overstroomd")) %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, 
                   color = ~pal(loc_typecode),
                   radius = ~ifelse(is.na(gr_mv), 5, 10),
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.5)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten", "Overstromingsgevoelig", "Recent overstroomd"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(#pal = pal, values = ~loc_typecode,
            colors = c("red", "blue"), labels = c("grondwater", "oppervlaktewater"),
            group = "Meetpunten", title = "Meetpunttype")
```

### Tijdreeksen

m-mv

```{r tijdreeks_raai_4, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 4 & loc_typecode != "S")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

mTAW, met aanduiding van de maaiveldhoogte in stippellijn

```{r tijdreeks_raai_4_TAW, message=FALSE, warning=FALSE}
ggplot(tijdreeks %>% 
         filter(transect_nr == 4)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(34, 37.5),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  # ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2017-01-01"), ymd("2020-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")), linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed")) +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

# Dataset met selectie van metingen

Doel: kalibratie van de overstromingsdiepte zoals voorspeld door de overstromingskaarten die aangemaakt worden in het kader van werkpakket 1 van het project Future Floodplains.

Selectie van metingen: alle metingen boven maaiveld

```{r}
WATINA_meas_above_surf_mombeek <- get_locs(watina,
                                           area_codes = "MOM",
                                           loc_type = c("P"),
                                           loc_validity = c("VLD", "ENT"),
                                           filterdepth_guess = TRUE,
                                           filterdepth_na = TRUE,
                                           filterdepth_range = c(0, 30),
                                           obswells = TRUE) %>% 
  inner_join(tbl(watina, "DimPeilpunt") %>%
               select(PeilpuntWID, PeilpuntCode, PeilpuntXCoordinaat, PeilpuntYCoordinaat),
             by = c("obswell_code" = "PeilpuntCode")) %>%
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID", "PeilpuntWID" = "PeilpuntWID")) %>%
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) &
           mMaaiveld > 0) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID") %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  select(area_name, loc_code, obswell_code, PeilpuntXCoordinaat, PeilpuntYCoordinaat,
         filterdepth, mvTAW, Datum, mTAW, mMaaiveld, ReprPeriode, MetingTypeNaam, PeilmetingCommentaar) %>% 
  rename(x = PeilpuntXCoordinaat, y = PeilpuntYCoordinaat) %>% 
  collect()
summary(WATINA_meas_above_surf_mombeek)
```

```{r include=FALSE, eval=FALSE}
WATINA_meas_above_surf_mombeek_vgl <- tijdreeks %>% 
  filter(!PeilpuntWID %in% c(40755, 41933) & mMaaiveld > 0 & loc_typecode == "P") %>% 
  left_join(tbl(watina, "DimMetingType") %>% collect(), by = "MetingTypeWID") %>% 
  select(loc_code, x, y, filterdepth, mvTAW, Datum, mTAW, mMaaiveld,
         MetingTypeCode, PeilmetingCommentaar)
summary(WATINA_meas_above_surf_mombeek_vgl)
```
Aantal meetpunten:
```{r}
WATINA_meas_above_surf_mombeek %>% 
  select(loc_code) %>%
  distinct() %>% 
  nrow()
  
```

```{r eval=FALSE, include=FALSE}
rbind(WATINA_meas_above_surf_mombeek, WATINA_meas_above_surf_dijle) %>% 
  write.table(file = "WATINA_meas_above_surf_mombeek_dijle.csv",
              dec = ".", sep = ";", row.names = FALSE, qmethod = "double")
```


<!-- # To do -->

<!-- * Hoe gevalideerde sondemetingen wegfilteren met afwijkende metingen (cfr. peilmetingcategorieën bij handmatige metingen)? Nu enkel probleem bij MOMP017 (kalibratiemeting 05/09/2018; wellicht fout in tabel "FactPeilMeting"; manueel meting weglaten uit dataset tijdreeks door extra `filter`-criterium in te voegen: `PeilpuntWID != 40755`) -->

<!-- Tabel met kenmerken van metingen per meetpunt, oplopend gesorteerd volgens transect, y-coördinaat, meetpunt: -->

<!-- ```{r warning=FALSE, message=FALSE} -->
<!-- tijdreeks %>% -->
<!--   mutate(gr_mv_ = ifelse(mMaaiveld > 0, 1, 0)) %>%  -->
<!--   # group_by(loc_code, gr_mv_) %>%  -->
<!--   # mutate(n_ = n()) %>% -->
<!--   # ungroup() %>%  -->
<!--   group_by(loc_code) %>%  -->
<!--   summarise(transect = min(transect_nr), -->
<!--             Date_first = min(Datum), -->
<!--             Date_last = max(Datum), -->
<!--             n = n(), -->
<!--             n_gr_mv = sum(gr_mv_), -->
<!--             y = min(y)) %>%  -->
<!--   arrange(transect, y, loc_code) %>%  -->
<!--   select(-y) %>%  -->
<!--   knitr::kable() -->
<!-- ``` -->

<!-- # Klad -->

<!-- ```{r} -->
<!-- tijdreeks %>%  -->
<!--   filter(PeilpuntWID != 40755 & grepl("MOMP00", loc_code)) %>%  -->
<!--   group_by(loc_code) %>%  -->
<!--   group_walk(~ write.csv(.x, file = paste0(.y$loc_code, "_tijdreeks_TAW.csv"))) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- test <- tijdreeks %>%  -->
<!--   filter(PeilpuntWID != 40755 & grepl("MOMP00", loc_code)) %>%  -->
<!--   group_by(loc_code) %>%  -->
<!--   group_walk(~ function(deze.subset){ -->
<!--     p <- ggplot(deze.subset) + -->
<!--       geom_line(aes(x = date(Datum), -->
<!--                     y = mTAW, -->
<!--                     colour = loc_code)) + -->
<!--       scale_x_date(date_breaks = "year", date_labels = "%Y") + -->
<!--       geom_line(aes(x = date(Datum), -->
<!--                     y = mvTAW, -->
<!--                     colour = loc_code), linetype = "dashed") + -->
<!--       theme(axis.text.x = element_text(angle = 90, vjust = 0.5), -->
<!--             panel.grid.minor.x = element_line(linetype = "dashed"), -->
<!--             legend.position = "right") + -->
<!--       labs(x = "Datum", y = "mTAW", colour = NULL) -->
<!--     ggsave(p, filename = paste0(deze.subset$loc_code, "_tijdreeks_TAW.jpeg"), device = "jpeg", -->
<!--            width = 8, height = 5.7, units = "in") -->
<!--   } -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- tijdreeks %>%  -->
<!--   filter(PeilpuntWID != 40755 & grepl("MOMP00", loc_code)) %>%  -->
<!--   group_by(loc_code) %>%  -->
<!--   group_walk(~ list(function(deze.subset){ -->
<!--     ggplot(deze.subset) + -->
<!--       geom_line(aes(x = date(Datum), -->
<!--                     y = mTAW, -->
<!--                     colour = loc_code)) + -->
<!--       scale_x_date(date_breaks = "year", date_labels = "%Y") + -->
<!--       geom_line(aes(x = date(Datum), -->
<!--                     y = mvTAW, -->
<!--                     colour = loc_code), linetype = "dashed") + -->
<!--       theme(axis.text.x = element_text(angle = 90, vjust = 0.5), -->
<!--             panel.grid.minor.x = element_line(linetype = "dashed"), -->
<!--             legend.position = "right") + -->
<!--       labs(x = "Datum", y = "mTAW", colour = NULL) -->
<!--     }) -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- tijdreeks %>% -->
<!--   filter(!PeilpuntWID %in% c(40755, 41933) -->
<!--          # & gr_mv == 1 -->
<!--          ) %>% -->
<!--   plyr::d_ply( -->
<!--     ~loc_code, -->
<!--     function(deze.subset){ -->
<!--       p <- ggplot(deze.subset) + -->
<!--         geom_line(aes(x = date(Datum), -->
<!--                       y = mTAW, -->
<!--                       colour = loc_code)) + -->
<!--         scale_x_date(date_breaks = "year", date_labels = "%Y") + -->
<!--         geom_line(aes(x = date(Datum), -->
<!--                       y = mvTAW, -->
<!--                       linetype = paste0("mv = ", round(mvTAW,2), " mTAW"))) + -->
<!--         theme(axis.text.x = element_text(angle = 90, vjust = 0.5), -->
<!--               panel.grid.minor.x = element_line(linetype = "dashed"), -->
<!--               legend.position = "right") + -->
<!--         labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL) -->
<!--       ggsave(p, filename = paste0(deze.subset$loc_code, "_tijdreeks_TAW.jpeg"), device = "jpeg", -->
<!--              width = 8, height = 5.7, units = "in") -->
<!--     } -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- tbl(watina, "vwDimPeilpunt") %>% -->
<!--   filter(PeilpuntWID == 41933) -->
<!-- ``` -->

