---
title: "Dataset validatie overstromingen - Dijle"
author: "Dries Adriaens"
date: "26-10-2020"
output:
  html_document:
    code_folding: hide
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(watina)
library(ggplot2)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(sf)
library(leaflet)
```

```{r connection}
watina <- connect_watina()
# library(inbodb)
# con <- connect_inbo_dbase("D0025_00_Watina")
```

# Doelstelling

Voor het project Future Floodplains worden de overstromingen in de alluviale vallei van de Dijle gemodelleerd (werkpakket 1, KULeuven). Voor de validatie van de overstromingskaarten voor de actuele toestand is er nood aan effectief gemeten waterstanden tijdens overstromingen. De vraag is of er op basis van de grondwatermeetpunten (en evt. oppervlaktewatermeetpunten) uit de WATINA databank dergelijke meetgegevens op een betrouwbare manier aangeleverd kunnen worden.

Onderstaand document verkent welke gegegens eventueel in aanmerking komen als dataset ter validatie van de overstromingskaarten.

# Aanpak

* selectie grondwatermeetpunten
* kijken of meetwaarden effectief overeenstemmen met reële waterpeilen boven maaiveld
  + gebruik maken van manuele metingen met specifieke labels (zgn. peilmetingcategorieën) die wijzen op effectieve overstromingen
  + uitsluiten van diepere peilbuizen waar een eventuele kweldruk tot peilen boven maaiveld kan leiden die niet overeenstemmen met waterpeilen tijdens overstromingen
  + checken van locatie van peilbuizen; meer kans op kweldruk aan de steilrand van de vallei
* groeperen van meetpunten in relevante raaien, veelal dwars georiënteerd op vallei
* eventueel relatie bekijken met aanwezige peilmetingen van oppervlaktewater (peilschalen)

We bekijken dit per komgrond.

# Komgrond Neerijse

Figuur invoegen? Of blijkt dat uit kaartjes met grondwatermeetpunten hieronder?

Het gaat hier om de komgrond ten westen van de Dijle ter hoogte van Neerijse, meer bepaald tussen de Neerijsebaan in het zuiden en de samenvloeiing van IJse en Dijle in het noorden. Deze komgrond wordt afgewaterd door de Leigracht die het gebied van zuid naar noord doormidden snijdt. De waterberging van deze komgrond wordt voornamelijk aangesproken door opstuwing van de Leigracht via de monding van de Ijse bij hoogwaterpeilen in de Dijle. De mate van opstuwing kan gestuurd worden via schotten op het stuw tussen Leigracht en Ijse.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Neerijse in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

Selectie van de meetpunten:

```{r meetpunten}
komgr_neerijse_loc_vec <- c("DYLP137", "DYLP105", "DYLP088", "DYLB028", "DYLB005", "DYLB080", "DYLB073", "DYLB072", "DYLB071", "DYLB065", "DYLP202", "DYLP204", "DYLP203", "DYLP021", "DYLP020", "DYLP034", "DYLP087", "DYLP086", "DYLP083", "DYLP082", "DYLP081", "DYLP095", "DYLP090", "DYLP089", "DYLP104", "DYLP098", "DYLP066", "DYLP065", "DYLP064", "DYLP080", "DYLP073", "DYLP072", "DYLP071", "DYLP070", "DYLP174", "DYLP170", "DYLP084", "DYLP028", "DYLP085", "DYLP005", "DYLP099", "DYLP047", "DYLP029")

komgr_neerijse_loc <- get_locs(watina,
                     loc_vec = komgr_neerijse_loc_vec,
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_range = c(0, 30))
komgr_neerijse_loc %>% collect() %>% knitr::kable()
```

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart_raai_1}
komgr_neerijse_loc_sf <- komgr_neerijse_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet(data = komgr_neerijse_loc_sf) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Tijdreeksen van grondwatermeetpunten

Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`).
```{r tijdreeks neerijse}
komgr_neerijse_tijdreeks <-
  komgr_neerijse_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   knitr::kable()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_plot, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

Hieruit komen een aantal zaken naar voren:

* de duur van de tijdreeksen varieert uiteraard per meetpunt. Niet alle meetpunten worden/werden even lang bemeten
* sinds 1998 lijken de tijdreeksen meer frequent het maaiveld te overschrijden, wat kan wijzen op meer frequente overstromingen; de veelheid aan meetpunten maakt het in de figuur echter moeilijk om te zien of dat te wijten is aan de opstart van een reeks nieuwe meetpunten, dan wel of het effectief om een toename van de stijghoogten gaat, met dan mogelijks ook een toename van de frequentie van overstromingen
* oudere metingen gebeurden veelal manueel; pas later werden de automatische meetsondes geïntroduceerd. Die laatste het voordeel hebben dat ze elke dag 2 metingen registreren en daardoor beter in staat zijn tijdelijke overstromingen te detecteren dan met manuele metingen, die in het beste geval slechts om de 14 dagen gebeuren
* veel meetreeksen lijken te stoppen rond 2015; de oorzaak hiervan is niet geheel duidelijk: gaat het hier om meetpunten die nog wel bemeten worden, maar waarvoor de de metingen nog niet aangevuld werden in de databank, of werden er veel meetpunten effectief afgesloten in die periode?

We kunnen uit deze lijst de meetpunten selecteren met peilen boven maaiveld. Dat levert onderstaande subset op:

```{r meetpunten met peilen boven maaiveld}
komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

```{r boven maaiveld}
aantal <- komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  count() %>% 
  collect() %>% 
  .$n
```

Het gaat dan nog steeds om `r aantal` van de `r length(komgr_neerijse_loc_vec)` meetpunten in de komgrond van Neerijse. In veel van de meetpunten stegen de stijghoogten dus minstens één of meerdere keren boven het maaiveld uit in de meetperiode.

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

Dergelijke metingen werden vastgesteld bij de volgende meetpunten:

```{r maaiveld overstroomd}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

Dat zijn er bijzonder weinig. Voor de overige meetpunten met stijghoogten boven maaiveld, is er dus geen absolute zekerheid dat de watertafel effectief boven maaiveld stond op het moment van opmeting, en er dus effectief sprake was van een overstroming, dan wel dat er (tijdelijk) een hogere/verhoogde kweldruk aanwezig was.

De tijdreeksen voor de meetpunten met bovengenoemde peilmetingcategorieën zitten vervat in onderstaande figuur, met aanduiding van de betreffende metingen (zwarte punten).

```{r maaiveld overstroomd tijdreeks}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(
  #   ylim = c(-1, 0.1),
  #   xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

De betreffende metingen lijken sterk geclusterd in de tijd. Wat meer ingezoomd op de periode met deze metingen levert dat onderstaande figuur op, met opsplitsing naar de twee verschillende peilmetingcategorieën.

```{r "maaiveld overstroomd tijdreeks ingezoomd"}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"))) +
  ## non-clipping zoom
  coord_cartesian(
  #   ylim = c(-1, 0.1),
    xlim = c(ymd("2013-07-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                 shape = PeilmetingCategorie),
             size = 3) +
  scale_shape(solid = FALSE) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Enkele opmerkingen bij bovenstaande figuur:

* Het is opmerkelijk dat heel wat van de peilmetingen met categorie "maaiveld onder water" toch grondwaterpeilen aangeven ónder maaiveld (tot > 5 cm soms) terwijl je hier toch net peilen bóven maaiveld zou verwachten. Mogelijks wijst dat erop dat het overstromingswater van elders afkomstig is (oppervlaktewater dus), en de peilen van oppervlakte- en grondwater -alvast tijdelijk- niet altijd overeenstemmen?
* De periode met beide peilmetingcategorieën is uitgesproken kort, net zoals het aantal meetpunten met dergelijke metingen. Wellicht worden deze categorieën niet systematisch genoteerd en toegekend aan handmatige meting in de databank. De lagere frequentie van handmatige metingen doet ook de kans dalen dat op het moment van opmeting het maaiveld net overstroomd is, zeker als de overstromingen eerder kortstondig van aard zijn
* DYLP047 en DYLP099 zijn resp. een diepe en ondiepe peilbuis op eenzelfde locatie. Het verschil in stijghoogte loopt in de winterperiode op tot meer dan 25 cm. Die vaststelling wijst alvast op een aanzienlijke kweldruk. De diepere peilbuis (DYLP047) geeft dus alvast niet de stand van de werkelijke watertafel weer en de peilen boven maaiveld wijzen dus zeker niet altijd op een overstroming. De metingen uit de tijdreeks van de ondiepe peilbuis van meetpunt DYLP099 zijn wellicht beter geschikt om dergelijke events aan te tonen. Helaas werd voor beide meetpunten enkel aan de allerlaatste meetwaarden de categorie "maaiveld onder water" toegekend (2019; zie onderstaande tabel) ...

```{r peilmetingen SOUWA TBWWL}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code, obswell_state, Datum, mMaaiveld, PeilmetingCategorie, PeilmetingCategorieCode) %>% 
  knitr::kable()
```

Samengevat kunnen we dus stellen dat de bruikbaarheid van de peilmetingcategorieën die wijzen op effectieve overstromingen, eerder beperkt is vanwege (1) het beperkt aantal meetpunten waarvoor ze toegekend werden en (2) hierdoor ook de beperkte ruimtelijke spreiding van deze bevestiging, maar zeker ook door (3) de beperkte periode waarin ze blijkbaar toegekend werden. Wellicht zijn deze categorieën ook van toepassing op metingen voor andere meetpunten, maar werden ze er niet systematisch geregistreerd.

### Kweldruk en het verschil tussen stijghoogte en waterpeil

Uit de voorgaande tijdreeksen van een zgn. peilbuiskoppel (peilbuizen met verschillende filterdiepte op eenzelfde locatie, bv. het koppel DYLP047-099 zoals beschreven hierboven) blijkt alvast dat de peilen die er gemeten worden afhankelijk zijn van de filterdiepte. Hoe dieper de filter van een peilbuis, hoe groter de kans dat de gemeten peilen in de buis (stijghoogten) hoger liggen dan in een peilbuis met een filter op geringere diepte. De druk in diepere grondwaterlagen ligt immers veelal hoger. Dat zorgt voor een opwaartse druk en dito beweging in het grondwater. Als de stijghoogten hoger liggen in de diepe dan in de ondiepe peilbuis binnen een peilbuiskoppel, dan spreken we van kwel(druk).

Een stijghoogte boven maaiveld betekent echter niet dat het (grond)waterpeil zich ook boven maaiveld bevindt. Grondwater kan lateraal wegvloeien terwijl het onder het maaiveld blijft en/of het kan gedraineerd worden van zodra het aan de oppervlakte komt, via greppels en grachten. Hoe dan ook zullen -althans in het grondwatersysteem van de Dijlevallei- de peilen in ondiepe peilbuizen de werkelijke grondwatertafel beter benaderen dan die van diepe peilbuizen.

Van eventuele peilbuiskoppels selecteren we dus best de meest ondiepe peilbuis om peilen te selecteren die kunnen wijzen op een effectieve overstroming van het maaiveld.

We kunnen dus best checken of het verschil in stijghoogte ook terug te vinden is bij andere diepe(re) peilbuizen of peilbuiskoppels. Hiervoor kijken we eerst naar de verdeling qua filterdiepten op basis van al de aanwezige peilbuizen:

```{r histogram peilbuisdiepte, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_neerijse_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit bovenstaande figuur kunnen we dan kiezen om alle peilbuizen dieper dan 3 m als "diep" te beschouwen. Het gaat om deze peilbuizen:

```{r diepe peilbuizen}
komgr_neerijse_loc %>% 
  filter(filterdepth >= 3) %>% 
  knitr::kable()
```

Deze diepe peilbuizen staan afgebeeld op onderstaand kaartje.

```{r kaart diepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Vervolgens kijken we of bij elk van de diepere peilbuizen ook een ondiepe peilbuis zit, die samen een zgn. "peilbuiskoppel" vormen. Voor die koppels kunnen we dan kijken of er sprake is van een stijghoogteverschil dat kan wijzen op de aanwezigheid van een kweldruk.

Uit onderstaand kaartje (diepe peilbuizen in blauw, ondiepe in rood) blijkt dat er voor de 3 diepere peilbuizen die starten met DYLP20* geen ondiepe tegenhanger aanwezig is. Dat is wel zo voor DYLP047, DYLP095 en DYLP170. Die laatste vormen dus met hun ondiepe tegenhangers, resp. DYLP099, DYLP098 en DYLP174, telkens een peilbuiskoppel.

```{r kaart diepe en ondiepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3),
                   label = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "red",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Voor deze punten bekijken we de tijdreeksen per peilbuiskoppel (diep-ondiep).

Koppel DYLP047-DYLP099:

```{r peilbuiskoppel1}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP047",
                                "DYLP099")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP095-DYLP098:

```{r peilbuiskoppel2}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP095",
                                "DYLP098")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP170-DYLP174:

```{r peilbuiskoppel3}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP170",
                                "DYLP174")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Uit bovenstaande figuren blijkt dat de stijghoogten in de diepere buizen systematisch minstens 20 cm hoger liggen dan in de ondiepe buizen van de peilbuiskoppels. Het verschil is het grootst voor de koppels DYLP170-DYLP174 en DYLP095-DYLP098, met verschillen die tot 50 cm bedragen. Voor het koppel DYLP047-DYLP099 liggen de verschillen lager, maar schommelen toch nog steeds rond de 20 cm.

Op basis van deze vaststellingen is het aannemelijk dat ook voor de diepere peilbuizen zónder ondiepe tegenhanger (DYLP2*) de gemeten peilen (stijghoogten) niet overeen zullen stemmen met de grondwatertafel. Hun tijdreeksen staan hieronder afgebeeld.

```{r tijdreeksen diepe peilbuizen buiten peilbuiskoppels}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP202", "DYLP203", "DYLP204")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
```

Enkel voor DYLP203 werden peilen boven maaiveld gemeten. Afgaande op bovenstaande vaststellingen is het dus twijfelachtig of die metingen overeenstemmen met effectieve overstromingen van het maaiveld. Naast het feit dat het om een diepe peilbuis gaat, laat ook de locatie aan de (steil)rand van de vallei vermoeden dat er in deze diepe peilbuis sprake is van een verhoogde kweldruk waardoor de gemeten stijghoogte nog extra kan afwijken van de effectieve grondwatertafel. Aan de voet van steile hellingen, op de overgang naar de vallei, is er immers vaak sprake van verhoogde kweldrukken doordat de topografische verschillen zorgen voor een plotse insnijding van het freatisch grondwatervlak of doordat afgesloten, watervoerende geologische lagen plots dagzomen en het grondwater bijgevolg onder een grotere druk uittreedt. 

We kunnen hier alvast besluiten dat het niet raadzaam is om de diepere peilbuizen te gebruiken om overstromingsdiepten te kalibreren. We verwijderen ze daarom uit de selectie.

De figuur met de tijdreeksen van de overblijvende meetpunten staat hieronder weergegeven (enkel ondiepe meetpunten met filterdiepte <= 3 m).

```{r tijdreeks_plot2, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks %>% 
                                          filter(filterdepth <= 3)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

## Oppervlaktewatermeetpunten

Samenhang tussen grondwaterstanden en oppervlaktewaterstanden, en meer specifiek dan de samenhang tussen pieken in beide typen waterstanden.

Voor de komgrond van Neerijse beschikken we over 2 peilschalen die de oppervlaktewaterpeilen van de Dijle en de Leigracht meten (zie onderstaand kaartje). De peilschaal op de Dijle ter hoogte van de Reigerstraat wordt evenwel niet langer bemeten.

* DYLS001 (Dijle)
* DYLS002 (1991-2014; handmetingen) en DYLS102 (2008-; sondemetingen) (Leigracht)

```{r oppervlaktewatermeetpunt komgr neerijse}
komgr_neerijse_loc_opp <- get_locs(watina,
                                   loc_vec = c("DYLS001", "DYLS102", "DYLS002"),
                                   loc_type = "S")

komgr_neerijse_loc_opp %>% collect() %>% knitr::kable()
```

```{r kaart peilschalen komgrond neerijse}
leaflet(data = komgr_neerijse_loc_opp %>% 
          collect() %>% 
          st_as_sf(coords = c("x","y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

```{r oppervlaktewatermeetpunt komgr neerijse tijdreeks}
komgr_neerijse_tijdreeks_opp <-
  komgr_neerijse_loc_opp %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

ggplot(komgr_neerijse_tijdreeks_opp) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

We bekijken de samenhang tussen grond- en oppervlaktewaterpeilen bij de bespreking van de verschillende raaien.

## Opsplitsing naar raaien
Met bespreking van samenhang tussen oppervlakte- en grondwaterpeilen?

### Raai 1

Type: transversaal

Meetpunten:

```{r}
komgr_neerijse_raai1_locs <- get_locs(
  watina, 
  loc_vec = c("DYLP043","DYLP064","DYLP086","DYLP087","DYLP085", "DYLP084", "DYLP104", "DYLP090"),
  filterdepth_range = c(0,3))

komgr_neerijse_raai1_locs %>% collect() %>% knitr::kable()
```

Ligging:

```{r}
leaflet(komgr_neerijse_raai1_locs %>% 
          collect() %>% 
          st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addTiles(group = "OSM") %>%
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE, zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE))
```

Tijdreeksen:

```{r}
komgr_neerijse_raai1_locs %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```
```{r include = FALSE}
get_locs(watina, loc_vec = "DYLP085") %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(TijdWID < 20170101 & TijdWID > 20161101) %>% 
  collect()
```

Samenhang grond- en oppervlaktewaterpeilen:

```{r}
get_locs(watina, loc_vec = c("DYLP085", "DYLP090", "DYLS102", "DYLS002"), loc_type = c("P", "B", "S")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code), alpha = 0.75) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

Uit bovenstaande figuur blijkt alvast het volgende:
* van het begin van de metingen (1991) tot midden 2000 stijgt het peil van de Leigracht systematisch; rond 2000 werd de Leigracht aangetakt aan de Ijse ter hoogte van de monding in de Dijle en werd de sifon onder de Ijse er verwijderd
* de pieken in de stijghoogten vallen samen met pieken in de oppervlaktewaterstanden van de Leigracht; dat wijst er op dat er overstromingen plaatsvinden via het oppervlaktewater vanuit de Leigracht (na opstuwing door hoge waterpeilen in de Dijle vanwege aantakking ter hoogte van IJsemonding); de vraag is of de gemeten stijghoogten op het moment van die overstromingen overeenstemmen met de waterpeilen van de overstromingen ...

### Raai 2

# Andere komgronden?

* komgrond Doode Bemde tussen waterlopen Grens Van Oud-Heverlee en Vaalbeek, ten oosten van Dijle; gedraineerd door Leibeek
* Langerodevijver
* Leibeek Oost (tot E40)
* Leibeek West (tot E40)
* Egenhovenbos

## Grondwatermeetpunten

## Tijdreeks grondwatermeetpunten

## Oppervlaktewatermeetpunten

# Openstaande vragen

* hoe de peilmetingen met bepaalde categorieën uit de tijdreeksen van meetsondes verwijderen (twijfelachtig, meetartefacten, e.d.)? Die categorieën worden nu steeds weer overschreven bij hercompensatie/-kalibratie van drukmetingen, en kunnen daardoor nu niet uitgefilterd worden. Enkel bij handmatige metingen zitten ze "ingebakken" ... Die categorieën zorgen nu voor uitschieters (zowel op- of neerwaarts) die mogelijks problemen geven als we ze als zodanig aanleveren ter kalibratie van de overstromingskaarten

```{r}
tbl(watina, "FactPeilMeting") %>% 
  select(starts_with("PeilmetingCategorie")) %>% 
  distinct() %>% 
  knitr::kable()
```


# Klad

```{r}
dyl_locs_opp <- get_locs(watina, loc_type = "S", area_codes = "DYL")

dyl_locs_opp %>% 
  collect()
```
```{r}
dyl_locs_opp %>% 
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326) %>% 
  leaflet() %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75),
             group = "Peilschalen") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "CartoWeb", "Ortho_VL_winter"),
    overlayGroups = "Peilschalen",
    options = layersControlOptions(collapsed = TRUE)
  )
```

