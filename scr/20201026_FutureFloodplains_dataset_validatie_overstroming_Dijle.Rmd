---
title: "Dataset validatie overstromingen - Dijle"
author: "Dries Adriaens"
date: "26-10-2020"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(watina)
library(ggplot2)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(sf)
library(leaflet)
```

```{r connection}
watina <- connect_watina()
# library(inbodb)
# con <- connect_inbo_dbase("D0025_00_Watina")
```

# Komgrond Neerijse

## Grondwatermeetpunten

We vragen al de meetpunten met peilbuis op (piëzometer: peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Neerijse in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis en in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

```{r meetpunten}
komgr_neerijse_loc_vec <- c("DYLP137", "DYLP105", "DYLP088", "DYLB028", "DYLB005", "DYLB080", "DYLB073", "DYLB072", "DYLB071", "DYLB065", "DYLP202", "DYLP204", "DYLP203", "DYLP021", "DYLP020", "DYLP034", "DYLP087", "DYLP086", "DYLP083", "DYLP082", "DYLP081", "DYLP095", "DYLP090", "DYLP089", "DYLP104", "DYLP098", "DYLP066", "DYLP065", "DYLP064", "DYLP080", "DYLP073", "DYLP072", "DYLP071", "DYLP070", "DYLP174", "DYLP170", "DYLP084", "DYLP028", "DYLP085", "DYLP005", "DYLP099", "DYLP047", "DYLP029")

komgr_neerijse_loc <- get_locs(watina,
                     loc_vec = komgr_neerijse_loc_vec,
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_range = c(0, 30))
komgr_neerijse_loc %>% collect() %>% knitr::kable()
```

De ligging van de grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart_raai_1}
komgr_neerijse_loc_sf <- komgr_neerijse_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet(data = komgr_neerijse_loc_sf) %>%
  addTiles() %>% 
  # addProviderTiles("OpenTopoMap") %>% 
  addCircleMarkers(label = komgr_neerijse_loc_sf$loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5)
```

## Tijdreeks grondwatermeetpunten

Het gaat hier enkel om de gevalideerde metingen.

```{r tijdreeks neerijse}
komgr_neerijse_tijdreeks <-
  komgr_neerijse_loc %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   knitr::kable()
```

```{r tijdreeks_plot, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

Meetpunten met peilen boven maaiveld:

```{r meetpunten met peilen boven maaiveld}
komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

```{r boven maaivel}
aantal <- komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  count() %>% 
  collect() %>% 
  .$n
```

Het gaat hier dus om nog `r aantal` van de `r length(komgr_neerijse_loc_vec)` meetpunten in de komgrond van Neerijse.

Meetpunten met manuele metingen (peilmetingen en/of kalibratiemetingen) met als categorieën "maaiveld onder water" (SOUWA) en "peilbuis staat onder water" (TBWWL):

```{r maaiveld overstroomd}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

Dat zijn er bijzonder weinig. Voor de overige meetpunten met peilen boven maaiveld, is er dus geen zekerheid over het feit dat de watertafel effectief boven maaiveld staat, en dus effectief wijst op een overstroming, dan wel dat er (tijdelijk) een hogere/verhoogde kweldruk aanwezig is. Enkel dus voor de (handmatige) peilmetingen die expliciet bovengenoemde peilpuntcategorieën toegekend kregen.

Tijdreeksen voor deze meetpunten, met aanduiding van de betreffende metingen (zwarte punten):

```{r maaiveld overstroomd tijdreeks}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(
  #   ylim = c(-1, 0.1),
  #   xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Wat meer ingezoomd op de periode met metingen met deze peilmetingcategorieën:

```{r "maaiveld overstroomd tijdreeks ingezoomd"}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"))) +
  ## non-clipping zoom
  coord_cartesian(
  #   ylim = c(-1, 0.1),
    xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                 shape = PeilmetingCategorie),
             size = 3) +
  scale_shape(solid = FALSE) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Twee opmerkingen bij bovenstaande figuur.

1.  DYLP047 en DYLP099 zijn resp. een diepe en ondiepe peilbuis op dezelfde plaats. Het verschil in stijghoogte loopt in de winterperiode op tot meer dan 25 cm. Dat wijst alvast op een aanzienlijke kweldruk. DYLP047 geeft daarom niet de stand van de werkelijke watertafel weer. De tijdreeks van DYLP099 zal die wel beter benaderen.  
2.  Daarnaast is het opmerkelijk dat een heel aantal van de peilmetingen met categorie "maaiveld onder water" toch peilen aangeven ónder maaiveld (tot > 5 cm soms) terwijl je hier toch peilen bóven maaiveld zou verwachten ...

We kunnen dan best checken of het verschil in stijghoogte ook terug te vinden is bij andere diepe(re) peilbuizen. Even kijken wat de verdeling is qua filterdiepten voor de peilbuizen:

```{r histogram peilbuisdiepte}
komgr_neerijse_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```
Uit bovenstaande figuur kunnen we dan kiezen om alle peilbuizen dieper dan 3 m als "diep" te beschouwen. Het gaat om deze peilbuizen:

```{r diepe peilbuizen}
komgr_neerijse_loc %>% 
  filter(filterdepth >= 3) %>% 
  knitr::kable()
```

Die hier gelegen zijn (diepe peilbuizen in blauw, ondiepe in rood):

```{r kaart diepe peilbuizen}
leaflet() %>%
  addTiles() %>% 
  # addProviderTiles("OpenTopoMap") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5)
```
We moeten dan nog kijken of bij elk van de diepere peilbuizen ook een ondiepe peilbuis zit, die samen een zgn. "peilbuiskoppel" vormen. Voor die koppels kunnen we dan kijken of een eventueel verschil in stijghoogte duidt op de aanwezigheid van een kweldruk.

Uit onderstaand kaartje (diepe peilbuizen in blauw, ondiepe in rood) blijkt dat er voor de 3 diepere peilbuizen die starten met DYLP20* geen ondiepe tegenhanger aanwezig is. Dat is wel zo voor DYLP047, DYLP095 en DYLP170. Die laatste vormen dus met hun ondiepe tegenhangers, resp. DYLP099, DYLP098 en DYLP174, telkens een peilbuiskoppel.

```{r kaart diepe en ondiepe peilbuizen}
leaflet() %>%
  addTiles() %>% 
  # addProviderTiles("OpenTopoMap") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3),
                   label = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "red",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5)
```

Voor deze punten kunnen we de tijdreeksen weergeven, telkens per koppel (diep-ondiep).

Koppel DYLP047-DYLP099:

```{r peilbuiskoppel1}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP047",
                                "DYLP099")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP095-DYLP098:

```{r peilbuiskoppel2}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP095",
                                "DYLP098")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP170-DYLP174:

```{r peilbuiskoppel3}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP170",
                                "DYLP174")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Uit bovenstaande figuren blijkt dat de stijghoogten in de diepere buizen systematisch minstens 20 cm hoger liggen dan in de ondiepe buizen van de peilbuiskoppels. Het verschil is het grootst voor de koppels DYLP170-DYLP174 en DYLP095-DYLP098, met verschillen die tot 50 cm bedragen. Voor het koppel DYLP047-DYLP099 liggen de verschillen lager, maar schommelen toch nog steeds rond de 20 cm.

We kunnen hier alvast besluiten dat het niet raadzaam is om de diepere peilbuizen te gebruiken om overstromingsdiepten te kalibreren. Die verwijderen we dus uit de selectie.

## Oppervlaktewatermeetpunten

Peilen nog aftoetsen aan oppervlaktewaterpeilen van leigracht(en) of Dijle (mTAW) ...
