---
title: "Dataset validatie overstromingen - Dijle"
author: "Dries Adriaens"
date: "26-10-2020"
output:
  html_document:
    code_folding: hide
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(watina)
library(ggplot2)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(sf)
library(leaflet)
library(wateRinfo)
```

```{r connection}
watina <- connect_watina()
# library(inbodb)
# con <- connect_inbo_dbase("D0025_00_Watina")
```

# Doelstelling

Voor het project Future Floodplains worden de overstromingen in de alluviale vallei van de Dijle gemodelleerd (werkpakket 1, KULeuven). Voor de validatie van de overstromingskaarten voor de actuele toestand is er nood aan effectief gemeten waterstanden tijdens overstromingen. De vraag is of er op basis van de grondwatermeetpunten (en evt. oppervlaktewatermeetpunten) uit de WATINA databank dergelijke meetgegevens op een betrouwbare manier aangeleverd kunnen worden.

Onderstaand document verkent welke gegegens eventueel in aanmerking komen als dataset ter validatie van de overstromingskaarten.

# Aanpak

* selectie grondwatermeetpunten
* kijken of meetwaarden effectief overeenstemmen met reële waterpeilen boven maaiveld
  + gebruik maken van manuele metingen met specifieke labels (zgn. peilmetingcategorieën) die wijzen op effectieve overstromingen
  + uitsluiten van diepere peilbuizen waar een eventuele kweldruk tot peilen boven maaiveld kan leiden die niet overeenstemmen met waterpeilen tijdens overstromingen
  + checken van locatie van peilbuizen; meer kans op kweldruk aan de steilrand van de vallei
* groeperen van meetpunten in relevante raaien, veelal dwars georiënteerd op vallei
* eventueel relatie bekijken met aanwezige peilmetingen van oppervlaktewater (peilschalen)

We bekijken dit per komgrond.

# Komgrond Neerijse

Figuur invoegen? Of blijkt dat uit kaartjes met grondwatermeetpunten hieronder?

Het gaat hier om de komgrond ten westen van de Dijle ter hoogte van Neerijse, meer bepaald tussen de Neerijsebaan in het zuiden en de samenvloeiing van IJse en Dijle in het noorden. Deze komgrond wordt afgewaterd door de Leigracht die het gebied van zuid naar noord doormidden snijdt. De waterberging van deze komgrond wordt voornamelijk aangesproken door opstuwing van de Leigracht via de monding van de Ijse bij hoogwaterpeilen in de Dijle. De mate van opstuwing kan gestuurd worden via schotten op het stuw tussen Leigracht en Ijse.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Neerijse in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

Selectie van de meetpunten:

```{r meetpunten}
komgr_neerijse_loc_vec <- c("DYLP137", "DYLP105", "DYLP088", "DYLB028", "DYLB005", "DYLB080", "DYLB073", "DYLB072", "DYLB071", "DYLB065", "DYLP202", "DYLP204", "DYLP203", "DYLP021", "DYLP020", "DYLP034", "DYLP087", "DYLP086", "DYLP083", "DYLP082", "DYLP081", "DYLP095", "DYLP090", "DYLP089", "DYLP104", "DYLP098", "DYLP066", "DYLP065", "DYLP064", "DYLP080", "DYLP073", "DYLP072", "DYLP071", "DYLP070", "DYLP174", "DYLP170", "DYLP084", "DYLP028", "DYLP085", "DYLP005", "DYLP099", "DYLP047", "DYLP029", "DYLP019", "DYLP018")

komgr_neerijse_loc <- get_locs(watina,
                     loc_vec = komgr_neerijse_loc_vec,
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_range = c(0, 30))
komgr_neerijse_loc %>% collect() %>% knitr::kable()
```

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart komgrond neerijse}
komgr_neerijse_loc_sf <- komgr_neerijse_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet(data = komgr_neerijse_loc_sf) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Tijdreeksen van grondwatermeetpunten

Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`).
```{r tijdreeks neerijse}
komgr_neerijse_tijdreeks <-
  komgr_neerijse_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   knitr::kable()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_plot, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

Hieruit komen een aantal zaken naar voren:

* de duur van de tijdreeksen varieert uiteraard per meetpunt. Niet alle meetpunten worden/werden even lang bemeten
* sinds 1998 lijken de tijdreeksen meer frequent het maaiveld te overschrijden, wat kan wijzen op meer frequente overstromingen; de veelheid aan meetpunten maakt het in de figuur echter moeilijk om te zien of dat te wijten is aan de opstart van een reeks nieuwe meetpunten, dan wel of het effectief om een toename van de stijghoogten gaat, met dan mogelijks ook een toename van de frequentie van overstromingen
* oudere metingen gebeurden veelal manueel; pas later werden de automatische meetsondes geïntroduceerd. Die laatste het voordeel hebben dat ze elke dag 2 metingen registreren en daardoor beter in staat zijn tijdelijke overstromingen te detecteren dan met manuele metingen, die in het beste geval slechts om de 14 dagen gebeuren
* veel meetreeksen lijken te stoppen rond 2015; de oorzaak hiervan is niet geheel duidelijk: gaat het hier om meetpunten die nog wel bemeten worden, maar waarvoor de de metingen nog niet aangevuld werden in de databank, of werden er veel meetpunten effectief afgesloten in die periode?

We kunnen uit deze lijst de meetpunten selecteren met peilen boven maaiveld. Dat levert onderstaande subset op:

```{r meetpunten met peilen boven maaiveld}
komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

```{r boven maaiveld}
aantal <- komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  count() %>% 
  collect() %>% 
  .$n
```

Het gaat dan nog steeds om `r aantal` van de `r length(komgr_neerijse_loc_vec)` meetpunten in de komgrond van Neerijse. In veel van de meetpunten stegen de stijghoogten dus minstens één of meerdere keren boven het maaiveld uit in de meetperiode.

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

Dergelijke metingen werden vastgesteld bij de volgende meetpunten:

```{r maaiveld overstroomd}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

Dat zijn er bijzonder weinig. Voor de overige meetpunten met stijghoogten boven maaiveld, is er dus geen absolute zekerheid dat de watertafel effectief boven maaiveld stond op het moment van opmeting, en er dus effectief sprake was van een overstroming, dan wel dat er (tijdelijk) een hogere/verhoogde kweldruk aanwezig was.

De tijdreeksen voor de meetpunten met bovengenoemde peilmetingcategorieën zitten vervat in onderstaande figuur, met aanduiding van de betreffende metingen (zwarte punten).

```{r maaiveld overstroomd tijdreeks}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(
  #   ylim = c(-1, 0.1),
  #   xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

De betreffende metingen lijken sterk geclusterd in de tijd. Wat meer ingezoomd op de periode met deze metingen levert dat onderstaande figuur op, met opsplitsing naar de twee verschillende peilmetingcategorieën.

```{r "maaiveld overstroomd tijdreeks ingezoomd"}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"))) +
  ## non-clipping zoom
  coord_cartesian(
  #   ylim = c(-1, 0.1),
    xlim = c(ymd("2013-07-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                 shape = PeilmetingCategorie),
             size = 3) +
  scale_shape(solid = FALSE) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Enkele opmerkingen bij bovenstaande figuur:

* Het is opmerkelijk dat heel wat van de peilmetingen met categorie "maaiveld onder water" toch grondwaterpeilen aangeven ónder maaiveld (tot > 5 cm soms) terwijl je hier toch net peilen bóven maaiveld zou verwachten. Mogelijks wijst dat erop dat het overstromingswater van elders afkomstig is (oppervlaktewater dus), en de peilen van oppervlakte- en grondwater -alvast tijdelijk- niet altijd overeenstemmen?
* De periode met beide peilmetingcategorieën is uitgesproken kort, net zoals het aantal meetpunten met dergelijke metingen. Wellicht worden deze categorieën niet systematisch genoteerd en toegekend aan handmatige meting in de databank. De lagere frequentie van handmatige metingen doet ook de kans dalen dat op het moment van opmeting het maaiveld net overstroomd is, zeker als de overstromingen eerder kortstondig van aard zijn
* DYLP047 en DYLP099 zijn resp. een diepe en ondiepe peilbuis op eenzelfde locatie. Het verschil in stijghoogte loopt in de winterperiode op tot meer dan 25 cm. Die vaststelling wijst alvast op een aanzienlijke kweldruk. De diepere peilbuis (DYLP047) geeft dus alvast niet de stand van de werkelijke watertafel weer en de peilen boven maaiveld wijzen dus zeker niet altijd op een overstroming. De metingen uit de tijdreeks van de ondiepe peilbuis van meetpunt DYLP099 zijn wellicht beter geschikt om dergelijke events aan te tonen. Helaas werd voor beide meetpunten enkel aan de allerlaatste meetwaarden de categorie "maaiveld onder water" toegekend (2019; zie onderstaande tabel) ...

```{r peilmetingen SOUWA TBWWL}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code, obswell_state, Datum, mMaaiveld, PeilmetingCategorie, PeilmetingCategorieCode) %>% 
  knitr::kable()
```

Samengevat kunnen we dus stellen dat de bruikbaarheid van de peilmetingcategorieën die wijzen op effectieve overstromingen, eerder beperkt is vanwege (1) het beperkt aantal meetpunten waarvoor ze toegekend werden en (2) hierdoor ook de beperkte ruimtelijke spreiding van deze bevestiging, maar zeker ook door (3) de beperkte periode waarin ze blijkbaar toegekend werden. Wellicht zijn deze categorieën ook van toepassing op metingen voor andere meetpunten, maar werden ze er niet systematisch geregistreerd.

### Kweldruk en het verschil tussen stijghoogte en waterpeil

Uit de voorgaande tijdreeksen van een zgn. peilbuiskoppel (peilbuizen met verschillende filterdiepte op eenzelfde locatie, bv. het koppel DYLP047-099 zoals beschreven hierboven) blijkt alvast dat de peilen die er gemeten worden afhankelijk zijn van de filterdiepte. Hoe dieper de filter van een peilbuis, hoe groter de kans dat de gemeten peilen in de buis (stijghoogten) hoger liggen dan in een peilbuis met een filter op geringere diepte. De druk in diepere grondwaterlagen ligt immers veelal hoger. Dat zorgt voor een opwaartse druk en dito beweging in het grondwater. Als de stijghoogten hoger liggen in de diepe dan in de ondiepe peilbuis binnen een peilbuiskoppel, dan spreken we van kwel(druk).

Een stijghoogte boven maaiveld betekent echter niet dat het (grond)waterpeil zich ook boven maaiveld bevindt. Grondwater kan lateraal wegvloeien terwijl het onder het maaiveld blijft en/of het kan gedraineerd worden van zodra het aan de oppervlakte komt, via greppels en grachten. Hoe dan ook zullen -althans in het grondwatersysteem van de Dijlevallei- de peilen in ondiepe peilbuizen de werkelijke grondwatertafel beter benaderen dan die van diepe peilbuizen.

Van eventuele peilbuiskoppels selecteren we dus best de meest ondiepe peilbuis om peilen te selecteren die kunnen wijzen op een effectieve overstroming van het maaiveld.

We kunnen dus best checken of het verschil in stijghoogte ook terug te vinden is bij andere diepe(re) peilbuizen of peilbuiskoppels. Hiervoor kijken we eerst naar de verdeling qua filterdiepten op basis van al de aanwezige peilbuizen:

```{r histogram peilbuisdiepte, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_neerijse_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit bovenstaande figuur kunnen we dan kiezen om alle peilbuizen dieper dan 3 m als "diep" te beschouwen. Het gaat om deze peilbuizen:

```{r diepe peilbuizen}
komgr_neerijse_loc %>% 
  filter(filterdepth >= 3) %>% 
  knitr::kable()
```

Deze diepe peilbuizen staan afgebeeld op onderstaand kaartje. Ze liggen allen in het meest zuidelijke deel van de komgrond.

```{r kaart diepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Vervolgens kijken we of bij elk van de diepere peilbuizen ook een ondiepe peilbuis zit, die samen een zgn. "peilbuiskoppel" vormen. Voor die koppels kunnen we dan kijken of er sprake is van een stijghoogteverschil dat kan wijzen op de aanwezigheid van een kweldruk.

Uit onderstaand kaartje (diepe peilbuizen in blauw, ondiepe in rood) blijkt dat er voor de 3 diepere peilbuizen die starten met DYLP20* geen ondiepe tegenhanger aanwezig is. Dat is wel zo voor DYLP047, DYLP095 en DYLP170. Die laatste vormen dus met hun ondiepe tegenhangers, resp. DYLP099, DYLP098 en DYLP174, telkens een peilbuiskoppel.

```{r kaart diepe en ondiepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3),
                   label = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "red",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Voor deze punten bekijken we de tijdreeksen per peilbuiskoppel (diep-ondiep).

Koppel DYLP047-DYLP099:

```{r peilbuiskoppel1}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP047",
                                "DYLP099")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP095-DYLP098:

```{r peilbuiskoppel2}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP095",
                                "DYLP098")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP170-DYLP174:

```{r peilbuiskoppel3}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP170",
                                "DYLP174")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Uit bovenstaande figuren blijkt dat de stijghoogten in de diepere buizen systematisch minstens 20 cm hoger liggen dan in de ondiepe buizen van de peilbuiskoppels. Het verschil is het grootst voor de koppels DYLP170-DYLP174 en DYLP095-DYLP098, met verschillen die tot 50 cm bedragen. Voor het koppel DYLP047-DYLP099 liggen de verschillen lager, maar schommelen toch nog steeds rond de 20 cm.

Op basis van deze vaststellingen is het aannemelijk dat ook voor de diepere peilbuizen zónder ondiepe tegenhanger (DYLP2*) de gemeten peilen (stijghoogten) niet overeen zullen stemmen met de grondwatertafel. Hun tijdreeksen staan hieronder afgebeeld.

```{r tijdreeksen diepe peilbuizen buiten peilbuiskoppels}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP202", "DYLP203", "DYLP204")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
```

Enkel voor DYLP203 werden peilen boven maaiveld gemeten. Afgaande op bovenstaande vaststellingen is het dus twijfelachtig of die metingen overeenstemmen met effectieve overstromingen van het maaiveld. Naast het feit dat het om een diepe peilbuis gaat, laat ook de locatie aan de (steil)rand van de vallei vermoeden dat er in deze diepe peilbuis sprake is van een verhoogde kweldruk waardoor de gemeten stijghoogte nog extra kan afwijken van de effectieve grondwatertafel. Aan de voet van steile hellingen, op de overgang naar de vallei, is er immers vaak sprake van verhoogde kweldrukken doordat de topografische verschillen zorgen voor een plotse insnijding van het freatisch grondwatervlak of doordat afgesloten, watervoerende geologische lagen plots dagzomen en het grondwater bijgevolg onder een grotere druk uittreedt. 

**Samengevat**: We kunnen hier alvast besluiten dat het niet raadzaam is om de diepere peilbuizen te gebruiken om overstromingsdiepten te kalibreren. We verwijderen ze daarom uit de selectie.

De figuur met de tijdreeksen van de overblijvende meetpunten staat hieronder weergegeven (enkel ondiepe meetpunten met filterdiepte <= 3 m).

```{r tijdreeks_plot2, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks %>% 
                                          filter(filterdepth <= 3)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

## Oppervlaktewatermeetpunten

Samenhang tussen grondwaterstanden en oppervlaktewaterstanden, en meer specifiek dan de samenhang tussen pieken in beide typen waterstanden.

Voor de komgrond van Neerijse beschikken we over 2 peilschalen die de oppervlaktewaterpeilen van de Dijle en de Leigracht meten (zie onderstaand kaartje). De peilschaal op de Dijle ter hoogte van de Reigerstraat wordt evenwel niet langer bemeten.

* DYLS001 (Dijle)
* DYLS002 (1991-2014; handmetingen) en DYLS102 (2008-; sondemetingen) (Leigracht)

```{r oppervlaktewatermeetpunt komgr neerijse}
komgr_neerijse_loc_opp <- get_locs(watina,
                                   loc_vec = c("DYLS001", "DYLS102", "DYLS002"),
                                   loc_type = "S")

komgr_neerijse_loc_opp %>% collect() %>% knitr::kable()
```

```{r kaart peilschalen komgrond neerijse}
leaflet(data = komgr_neerijse_loc_opp %>% 
          collect() %>% 
          st_as_sf(coords = c("x","y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

```{r oppervlaktewatermeetpunt komgr neerijse tijdreeks}
komgr_neerijse_tijdreeks_opp <-
  komgr_neerijse_loc_opp %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

ggplot(komgr_neerijse_tijdreeks_opp) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

We bekijken de samenhang tussen grond- en oppervlaktewaterpeilen bij de bespreking van de verschillende raaien.

## Opsplitsing naar raaien
Met bespreking van samenhang tussen oppervlakte- en grondwaterpeilen?

### Raai 1

#### Type: transversaal

#### Meetpunten:

```{r}
komgr_neerijse_raai1_locs <- get_locs(
  watina, 
  loc_vec = c("DYLP043","DYLP064","DYLP086","DYLP087","DYLP085", "DYLP084", "DYLP104", "DYLP090"),
  filterdepth_range = c(0,3))

komgr_neerijse_raai1_locs %>% collect() %>% knitr::kable()
```

#### Ligging:

```{r}
leaflet(komgr_neerijse_raai1_locs %>% 
          collect() %>% 
          st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addTiles(group = "OSM") %>%
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE, zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb", "DTM"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE))
```

#### Tijdreeksen:

```{r}
komgr_neerijse_raai1_locs %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```
```{r include = FALSE}
get_locs(watina, loc_vec = "DYLP085") %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(TijdWID < 20170101 & TijdWID > 20161101) %>% 
  collect()
```

#### Samenhang grond- en oppervlaktewaterpeilen:

```{r, warning = FALSE}
get_locs(watina, loc_vec = c("DYLP085", "DYLP090", "DYLS102", "DYLS002"), loc_type = c("P", "B", "S")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)"))
            , alpha = 0.75) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = soilsurf_ost,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

Uit bovenstaande figuur blijkt alvast het volgende:
* van het begin van de metingen (1991) tot midden 2000 stijgt het peil van de Leigracht systematisch; rond 2000 werd de Leigracht aangetakt aan de Ijse ter hoogte van de monding in de Dijle en werd de sifon onder de Ijse er verwijderd
* de pieken in de stijghoogten vallen samen met pieken in de oppervlaktewaterstanden van de Leigracht; dat wijst er op dat er overstromingen plaatsvinden via het oppervlaktewater vanuit de Leigracht (na opstuwing door hoge waterpeilen in de Dijle vanwege aantakking ter hoogte van IJsemonding); de vraag is of de gemeten stijghoogten op het moment van die overstromingen overeenstemmen met de waterpeilen van de overstromingen ...

### Raai 2

#### Type: transversaal

#### Meetpunten:

```{r}
komgr_neerijse_raai2_locs <- get_locs(
  watina, 
  loc_vec = c("DYLB005",
              "DYLB071",
              "DYLB072",
              "DYLB073",
              "DYLP019",
              "DYLP020",
              "DYLP070",
              "DYLP071",
              "DYLP072",
              "DYLP073",
              "DYLP080",
              "DYLP081",
              "DYLP082",
              "DYLP083",
              "DYLP005"),
  filterdepth_range = c(0,3))

komgr_neerijse_raai2_locs %>% collect() %>% knitr::kable()
```

#### Ligging:

```{r}
leaflet(komgr_neerijse_raai2_locs %>% 
          collect() %>% 
          st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addTiles(group = "OSM") %>%
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE, zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE))
```

#### Tijdreeksen:

```{r}
komgr_neerijse_raai2_locs %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```
Schijnbaar minder uitgesproken overstromingen (zowel naar frequentie als peilen) in vergelijking met raai 1, die meer zuidelijk gelegen is.

#### Samenhang grond- en oppervlaktewaterpeilen:

```{r warning = FALSE}
get_locs(watina, loc_vec = c("DYLP072", "DYLP073", "DYLP005", "DYLS102", "DYLS002"), loc_type = c("P", "B", "S")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")), alpha = 0.75) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = soilsurf_ost,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

## Finale selectie grondwatermeetpunten en -metingen

Selectiecriteria meetpunt
* metingen boven maaiveld,
* diepte peilbuis,
* ruimtelijke ligging
* andere?

Selectiecriteria metingen
* PeilMetingCategorie
* andere?

# Komgrond Doode Beemde
Deze komgrond ligt op de oostelijke oever van de Dijle en wordt afgelijnd door de  waterlopen Grens Van Oud-Heverlee in het zuiden, de Vaalbeek/Molenbeek in het noorden, en de spoorweg in het oosten. De komgrond wordt gedraineerd door de Leibeek, die hier ook ontspringt.

```{r}
komgr_doodebeemde_O_incl <- 1
```


Noot: het is onduidelijk of ook de meetpunten ten oosten van de spoorwegbedding tot deze komgrond moeten gerekend worden. In principe lijkt dit stuk wel hydrologisch verbonden via de doorgang onder de spoorweg (verbindingsweggetje naar Waversebaan). Indien mee te nemen: `komgr_doodebeemde_O_incl <- 1`. Nu: `r komgr_doodebeemde_O_incl`.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van de Doode Beemde in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

```{r}
komgr_doodebeemde_O_loc_vec <- c("DYLP052", "DYLB050", "DYLB051", "DYLB056", "DYLP053", "DYLP056", "DYLP012", "DYLP013", "DYLP026", "DYLP038", "DYLP050", "DYLP051", "DYLP037")

komgr_doodebeemde_W_loc_vec <- c("BAOL502", "DYLR003", "DYLP075", "DYLP041", "DYLB039", "DYLB093", "DYLP024", "DYLP040", "DYLP007", "DYLP008", "DYLP009", "DYLP015", "DYLP017", "DYLP022", "DYLP039", "DYLP054", "DYLP059", "DYLP062", "DYLP063", "DYLP074", "DYLP091", "DYLP092", "DYLP093", "DYLS003", "DYLS004", "DYLP016", "DYLP004", "DYLP006", "DYLP042", "DYLP055", "DYLP023")

if (komgr_doodebeemde_O_incl == 1) {komgr_doodebeemde_loc_vec <- c(komgr_doodebeemde_O_loc_vec, komgr_doodebeemde_W_loc_vec)} else {komgr_doodebeemde_loc_vec <- komgr_doodebeemde_W_loc_vec}
```

Selectie van de meetpunten:

```{r}
komgr_doodebeemde_loc <- get_locs(watina,
                     loc_vec = komgr_doodebeemde_loc_vec,
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_range = c(0, 30))
komgr_doodebeemde_loc %>% collect() %>% knitr::kable()
```

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart komgrond neerijse}
komgr_doodebeemde_loc_sf <- komgr_doodebeemde_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    data = komgr_doodebeemde_loc_sf %>% filter(filterdepth < 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "red", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten < 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_doodebeemde_loc_sf %>% filter(filterdepth >= 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "blue", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten >= 2.5 m") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten < 2.5 m", "Meetpunten >= 2.5 m"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Spreiding qua filterdiepte van de peilbuizen:

```{r histogram peilbuisdiepte doodebeemde, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_doodebeemde_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit de kaart en bovenstaande figuur leiden we af dat er 8 (5 indien deel van de komgrond ten oosten van de spoorweg niet meegerekend wordt) diepere (> 2.5 m diep) peilbuizen zijn, waarvan er 6 (resp. 4) deel uitmaken van een peilbuiskoppel (ondiep-diep). Eén peilbuiskoppel bestaat uit 2 diepere peilbuizen.

* DYLP074-091 (2 diepere peilbuizen)
* DYLP008-016
* DYLP017-092

Indien de meetpunten ten oosten van de spoorweg ook meegenomen worden, dan komen er nog volgende peilbuiskoppels bij:

* DYLP051-050
* DYLP053-052

## Tijdreeksen van grondwatermeetpunten

Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`), die bovendien als betrouwbaar gelden (`is.na(PeilmetingCategorie) | PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")`).
```{r tijdreeks doodebeemde}
komgr_doodebeemde_tijdreeks <-
  komgr_doodebeemde_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  mutate(OW = ifelse(loc_code %in% komgr_doodebeemde_O_loc_vec, "Oost", "West")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   collect()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_doodebeemde_plot, message=FALSE, warning=FALSE}
ggplot(komgr_doodebeemde_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_doodebeemde_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Hieruit komen een aantal zaken naar voren:

* de duur van de tijdreeksen varieert uiteraard per meetpunt. Niet alle meetpunten worden/werden even lang bemeten
* sinds 1998 lijken ook hier, net als in de komgrond van Neerijse, de tijdreeksen meer frequent het maaiveld te overschrijden, wat kan wijzen op meer frequente overstromingen; de veelheid aan meetpunten maakt het in de figuur echter moeilijk om te zien of dat te wijten is aan de opstart van een reeks nieuwe meetpunten, dan wel of het effectief om een toename van de stijghoogten gaat, met dan mogelijks ook een toename van de frequentie van overstromingen
* oudere metingen gebeurden veelal manueel; pas later werden de automatische meetsondes geïntroduceerd. Die laatste het voordeel hebben dat ze elke dag 2 metingen registreren en daardoor beter in staat zijn tijdelijke overstromingen te detecteren dan met manuele metingen, die in het beste geval slechts om de 14 dagen gebeuren
* veel meetreeksen lijken te stoppen rond 2015; de oorzaak hiervan is niet geheel duidelijk: gaat het hier om meetpunten die nog wel bemeten worden, maar waarvoor de de metingen nog niet aangevuld werden in de databank, of werden er veel meetpunten effectief afgesloten in die periode?

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

Dergelijke metingen werden vastgesteld bij de volgende meetpunten:

```{r maaiveld overstroomd doodebeemde}
komgr_doodebeemde_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_doodebeemde_loc, by = "loc_code") %>% 
  knitr::kable()
```

Dat zijn er bijzonder weinig. Voor de overige meetpunten met stijghoogten boven maaiveld, is er dus geen absolute zekerheid dat de watertafel effectief boven maaiveld stond op het moment van opmeting, en er dus effectief sprake was van een overstroming, dan wel dat er (tijdelijk) een hogere/verhoogde kweldruk aanwezig was.

De tijdreeksen voor de meetpunten met bovengenoemde peilmetingcategorieën zitten vervat in onderstaande figuur, met aanduiding van de betreffende metingen (zwarte punten).

```{r maaiveld overstroomd tijdreeks doodebeemde}
temp <- komgr_doodebeemde_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(
  #   ylim = c(-1, 0.1),
  #   xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_doodebeemde_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

De betreffende metingen lijken sterk geclusterd in de tijd. Wat meer ingezoomd op de periode met deze metingen levert dat onderstaande figuur op, met opsplitsing naar de twee verschillende peilmetingcategorieën.

```{r maaiveld overstroomd tijdreeks ingezoomd doodebeemde}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"))) +
  ## non-clipping zoom
  coord_cartesian(
  #   ylim = c(-1, 0.1),
    xlim = c(ymd("2013-07-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_doodebeemde_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                 shape = PeilmetingCategorie),
             size = 3) +
  scale_shape(solid = FALSE) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Enkele opmerkingen bij bovenstaande figuur:

* De periode met beide peilmetingcategorieën is uitgesproken kort, net zoals het aantal meetpunten met dergelijke metingen. Wellicht worden deze categorieën niet systematisch genoteerd en toegekend aan handmatige meting in de databank. De lagere frequentie van handmatige metingen doet ook de kans dalen dat op het moment van opmeting het maaiveld net overstroomd is, zeker als de overstromingen eerder kortstondig van aard zijn

```{r peilmetingen SOUWA TBWWL doodebeemde}
komgr_doodebeemde_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code, obswell_state, Datum, mMaaiveld, PeilmetingCategorie, PeilmetingCategorieCode) %>% 
  knitr::kable()
```

> **Samengevat**: we kunnen dus stellen dat de bruikbaarheid van de peilmetingcategorieën die wijzen op effectieve overstromingen, eerder beperkt is vanwege (1) het beperkt aantal meetpunten waaraan ze toegekend werden en (2) hierdoor ook de beperkte ruimtelijke spreiding van deze bevestiging, maar zeker ook door (3) de beperkte periode waarin, en dus metingen waaraan ze blijkbaar toegekend werden. Wellicht zijn deze categorieën ook van toepassing op metingen voor andere meetpunten, maar werden ze er niet systematisch geregistreerd.

### Kweldruk en het verschil tussen stijghoogte en waterpeil

Uit de metadata van de peilbuizen in de komgrond van de Doode Beemde blijkt dat de filter van een aantal peilbuizen dieper dan 2.5 m onder het maaiveld ligt. Veelal gaat het hier om peilbuizen die op dezelfde locatie ook een ondiepere tegenhanger hebben waarmee ze een zgn. peilbuiskoppel vormen (zie hoger).

We bekijken hieronder de tijdreeksen van de reeds vermelde peilbuiskoppels (ondiep-diep) om te kijken of er sprake is van stijghoogteverschillen tussen de diepe en ondiepe peilbuizen binnen een koppel, die dan kan duiden op een kweldruk. Bij een kweldruk is het alvast wenselijk om enkel de stijghoogten van de ondiepe peilbuis te gebruiken om een idee te krijgen van effectieve overstromingshoogten van het maaiveld.

* DYLP074-091 (2 diepere peilbuizen)
```{r peilbuiskoppel1 doodebeemde}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% c("DYLP074",
                                "DYLP091")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```
De stijghoogte overschrijdt hier slechts éénmaal het maaiveld. Deze observatie is eerder twijfelachtig. 

* DYLP008-016
```{r peilbuiskoppel2 doodebeemde}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% c("DYLP008",
                                "DYLP016")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```
In de jaren 1990 lijkt er vrijwel geen sprake van een kweldruk. Vanaf 1998 stijgen de gemeten peilen echter regelmatig boven het maaiveld, en lijkt er wel een drukverschil te zijn tussen beide peilbuizen. Vanaf 2006 lijken de verschillen dan weer af te nemen, met vreemde sprongen (bv. 2010-2013) vanwege een onvolledige dataset. Raadzaam om sowieso enkele de stijghoogten van de ondiepe peilbuis (DYLP008) te gebruiken in een mogelijke validatieset voor gemodelleerde overstromingsdieptekaarten.

* DYLP017-092
```{r peilbuiskoppel3 doodebeemde}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% c("DYLP017",
                                "DYLP092")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Hier worden geen overschrijdingen van het maaiveld vastgesteld, dus niet relevant.

Noot: indien meetpunten ten oosten van de spoorweg ook meegenomen worden, dan komen er nog volgende peilbuiskoppels bij:

* DYLP051-050
```{r peilbuiskoppel4 doodebeemde, include=FALSE}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% c("DYLP050",
                                "DYLP051")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Hier zijn wel degelijk verschillen in stijghoogte aanwezig.


* Peilbuiskoppel DYLP053-052

```{r peilbuiskoppel5 doodebeemde, include=FALSE}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% c("DYLP052",
                                "DYLP053")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```
Hier lijken de verschillen in stijghoogte dan weer miniem.

> **Samengevat**: het is raadzaam om sowieso enkel de ondiepe peilbuizen te gebruiken (< 2.5 m), ook als ze geen deel uitmaken van een peilbuiskoppel

### Stijghoogten boven maaiveld

Op basis van bovenstaande kunnen we uit de globale lijst van meetpunten die meetpunten selecteren

* met een filterdiepte minder dan 2.5 m
* én met peilen boven maaiveld  

Dat levert onderstaande subset op:

```{r meetpunten met peilen boven maaiveld doodebeemde}
komgr_doodebeemde_loc_fltrd <- komgr_doodebeemde_tijdreeks %>% 
  filter(mMaaiveld > 0 & filterdepth <= 2.5) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_doodebeemde_loc, by = "loc_code") %>%
  mutate(OW = ifelse(loc_code %in% komgr_doodebeemde_O_loc_vec, "Oost", "West"))

komgr_doodebeemde_loc_fltrd_vec <- komgr_doodebeemde_loc_fltrd %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

komgr_doodebeemde_loc_fltrd %>% 
  collect() %>% 
  knitr::kable()
```

In `r length(komgr_doodebeemde_loc_fltrd_vec)` van de `r length(komgr_doodebeemde_loc_vec)` meetpunten in de komgrond van de Doode Beemde hebben de stijghoogten dus ooit eens boven maaiveld gelegen in ondiepe peilbuizen.

Figuur met de tijdreeksen voor de subset van ondiepe meetpunten met minstens één of meerdere stijghoogten boven maaiveld in westelijk deel van de komgrond:

```{r tijdreeks_doodebeemde_west_plot_bovenmaaiveld, message=FALSE, warning=FALSE}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% komgr_doodebeemde_loc_fltrd_vec & OW == "West")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Figuur met de tijdreeksen voor de subset van ondiepe meetpunten met minstens één of meerdere stijghoogten boven maaiveld in oostelijk deel van de komgrond:

```{r tijdreeks_doodebeemde_oost_plot_bovenmaaiveld, message=FALSE, warning=FALSE}
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% komgr_doodebeemde_loc_fltrd_vec & OW == "Oost")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Tijdreeksen voor ondiepe meetpunten met gemeten stijghoogten hoger dan *25 cm* boven maaiveld, in m-mv, westelijk deel van komgrond:

```{r tijdreeks_doodebeemde_west_plot_bovenmaaiveld25cm_mv, message=FALSE, warning=FALSE}
temp <- komgr_doodebeemde_tijdreeks %>% 
                  filter(mMaaiveld > 0.25 & filterdepth <= 2.5) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp & OW == "West")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Tijdreeksen voor ondiepe meetpunten met gemeten stijghoogten hoger dan *25 cm* boven maaiveld, in m-mv, oostelijk deel van komgrond:

```{r tijdreeks_doodebeemde_oost_plot_bovenmaaiveld25cm_mv, message=FALSE, warning=FALSE}
temp <- komgr_doodebeemde_tijdreeks %>% 
                  filter(mMaaiveld > 0.25 & filterdepth <= 2.5) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()
ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp & OW == "Oost")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

in mTAW, ondiepe peilbuizen, westelijk deel, met vermelding van maaiveldhoogte:

```{r tijdreeks_doodebeemde_west_plot_bovenmaaiveld25cm_taw1, message=FALSE, warning=FALSE}
temp <- komgr_doodebeemde_tijdreeks %>% 
                  filter(mMaaiveld > 0.25 & filterdepth <= 2.5) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp & OW == "West")) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )
            ) +
  ## non-clipping zoom
  coord_cartesian(
    # xlim = c(ymd("2007-01-01"), ymd("2021-01-01")),
    ylim = c(25.5,28)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )
            ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

in mTAW, ondiepe peilbuizen, oostelijk deel, met vermelding van maaiveldhoogte:

```{r tijdreeks_doodebeemde_oost_plot_bovenmaaiveld25cm_taw1, message=FALSE, warning=FALSE}
temp <- komgr_doodebeemde_tijdreeks %>% 
                  filter(mMaaiveld > 0.25 & filterdepth <= 2.5) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_doodebeemde_tijdreeks %>% 
         filter(loc_code %in% temp & OW == "Oost")) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )
            ) +
  ## non-clipping zoom
  coord_cartesian(
    # xlim = c(ymd("2007-01-01"), ymd("2021-01-01")),
    ylim = c(25.5,28)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )
            ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

## Oppervlaktewatermeetpunten

Voor de komgrond van de Doode Beemde beschikken we over 2 peilschalen die de oppervlaktewaterpeilen van de Leibeek en de Vaalbeek/Molenbeek meten (zie onderstaand kaartje). Het gaat hier evenwel om handmetingen tot eind 2014.

* DYLS003 (Leibeek)
* DYLS004 (Vaalbeek/Molenbeek)

```{r oppervlaktewatermeetpunt komgr doodebeemde}
komgr_doodebeemde_loc_opp <- get_locs(watina,
                                   loc_vec = c("DYLS003", "DYLS004"),
                                   loc_type = "S")

komgr_doodebeemde_loc_opp %>% collect() %>% knitr::kable()
```

```{r kaart peilschalen komgrond doodebeemde}
leaflet(data = komgr_doodebeemde_loc_opp %>% 
          collect() %>% 
          st_as_sf(coords = c("x","y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

```{r oppervlaktewatermeetpunt komgr doodebeemde tijdreeks}
komgr_doodebeemde_tijdreeks_opp <-
  komgr_doodebeemde_loc_opp %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

ggplot(komgr_doodebeemde_tijdreeks_opp) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_doodebeemde_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

## Opsplitsing naar raaien
### Raai 1
#### Meetpunten:
#### Ligging:
#### Tijdreeksen:
#### Samenhang grond- en oppervlaktewaterpeilen

# Komgrond Langerodevijver
Het gaat hier om de komgrond tussen Ijse en Ruwaal, op de westelijke oever van de Dijle, die wordt doorsneden door de Leigracht. Aangezien de Leigracht onderbroken werd ter hoogte van de Ijse functioneert deze komgrond onafhankelijk van de zuidelijk gelegen komgrond van Neerijse.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Langerode in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

Selectie van de meetpunten:

```{r}
komgr_langerode_loc <- get_locs(watina,
                     loc_vec = c("DYLP101", "DYLP102", "DYLP111", "DYLP211", "DYLP139", "DYLP163", "DYLP110", "DYLP109", "DYLP222", "DYLP223"),
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_guess = TRUE,
                     filterdepth_na = TRUE,
                     filterdepth_range = c(0, 30))
komgr_langerode_loc %>% collect() %>% knitr::kable()
```

Voor de helft van de peilbuizen is de peilbuislengte, en dus ook de filterdiepte, niet gekend.

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart komgrond langerode}
komgr_langerode_loc_sf <- komgr_langerode_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    data = komgr_langerode_loc_sf %>% filter(filterdepth < 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "red", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten < 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_langerode_loc_sf %>% filter(filterdepth >= 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "blue", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten >= 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_langerode_loc_sf %>% filter(is.na(filterdepth)),
    label = ~loc_code, fill = FALSE, weight = 3, color = "orange", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten diepte ongekend") %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten < 2.5 m", "Meetpunten >= 2.5 m", "Meetpunten diepte ongekend"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Spreiding qua filterdiepte van de peilbuizen, wetende dat voor de helft geen filterdiepte bekend is:

```{r histogram peilbuisdiepte langerode, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_langerode_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit de kaart en bovenstaande figuur leiden we af dat er alvast 2 diepere (> 2.5 m diep) peilbuizen zijn. Van de helft van de peilbuizen kennen we evenwel de peilbuislengte (en dus ook de filterdiepte) niet.
Er zijn geen peilbuiskoppels aanwezig (diepe en ondiepe peilbuis op eenzelfde locatie) in de komgrond van Langerode.

## Tijdreeksen van grondwatermeetpunten
Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`), die bovendien als betrouwbaar gelden (`is.na(PeilmetingCategorie) | PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")`).
```{r tijdreeks langerode}
komgr_langerode_tijdreeks <-
  komgr_langerode_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   collect()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_langerode_plot, message=FALSE, warning=FALSE}
ggplot(komgr_langerode_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_langerode_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```
Wat meer ingezoomd op het bereik tussen -1 en 0 m m-mv:

```{r tijdreeks_langerode_plot, message=FALSE, warning=FALSE}
ggplot(komgr_langerode_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(-0.5, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_langerode_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Hieruit komen een aantal zaken naar voren:

* de stijghoogten komen in de meetpunten nauwelijks substantieel boven maaiveld uit, zelfs niet in de diepere peilbuizen
* de duur van de tijdreeksen varieert uiteraard per meetpunt. Niet alle meetpunten worden/werden even lang bemeten
* oudere metingen gebeurden veelal manueel; pas later werden de automatische meetsondes geïntroduceerd. Die laatste het voordeel hebben dat ze elke dag 2 metingen registreren en daardoor beter in staat zijn tijdelijke overstromingen te detecteren dan met manuele metingen, die in het beste geval slechts om de 14 dagen gebeuren
* meetpunt DYLP109 kende vroeger een opvallend grotere amplitude; de stijghoogten liggen sinds de herstart van de metingen in 2019 beduidend hoger in de zomerperiode dan in de periode vóór 2015, en dat ondanks de droge klimatologische omstandigheden in 2019 en 2020

### Peilmeting met labels die wijzen op effectieve overstromingen

Zoals uit de tijdreeksen hierboven al bleek, blijven de stijghoogten vrijwel steeds onder maaiveldhoogte. Aan de weinige metingen met stijghoogten boven maaiveld werd nergens een label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Deze labels worden trouwens enkel toegekend aan manuele metingen, en dus niet aan automatische (sonde-)metingen.

### Kweldruk en het verschil tussen stijghoogte en waterpeil
Aangezien er geen peilbuiskoppels aanwezig zijn in deze komgrond, is het ook niet mogelijk om een kweldruk aan te tonen op basis van meetgegevens.

### Stijghoogten boven maaiveld
In de volgende meetpunten is er sprake van één of meer tijdstippen waarop de stijghoogte boven maaiveld lag (n = aantal metingen met stijghoogte boven maaiveld; max = maximum stijghoogte boven maaiveld).

```{r meetpunten met peilen boven maaiveld doodebeemde}
komgr_langerode_loc_fltrd <- komgr_langerode_tijdreeks %>% 
  filter(mMaaiveld > 0) %>% 
  group_by(loc_code) %>% 
  summarise(n = n(), max = max(mMaaiveld)) %>% 
  select(loc_code, n, max) %>% 
  distinct() %>%
  inner_join(komgr_langerode_loc, by = "loc_code")

komgr_langerode_loc_fltrd_vec <- komgr_langerode_loc_fltrd %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

komgr_langerode_loc_fltrd %>% 
  collect() %>% 
  knitr::kable()
```

Hieronder de tijdsreeksen van de betreffende meetpunten, met aanduiding van de stijghoogten boven maaiveld.

```{r tijdreeks_langerode_west_plot_bovenmaaiveld, message=FALSE, warning=FALSE}
ggplot(komgr_langerode_tijdreeks %>% 
         filter(loc_code %in% komgr_langerode_loc_fltrd_vec)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  geom_point(data = komgr_langerode_tijdreeks %>% 
               filter(loc_code %in% komgr_langerode_loc_fltrd_vec &
                        mMaaiveld > 0),
             aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                shape = "boven mv"), size = 3, alpha = 0.5) +
  scale_shape(solid = FALSE) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL, shape = NULL)
```
Meer focus op periode sinds 2006:

```{r tijdreeks_langerode_west_plot_bovenmaaiveld, message=FALSE, warning=FALSE}
ggplot(komgr_langerode_tijdreeks %>% 
         filter(loc_code %in% komgr_langerode_loc_fltrd_vec)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  geom_point(data = komgr_langerode_tijdreeks %>% 
               filter(loc_code %in% komgr_langerode_loc_fltrd_vec &
                        mMaaiveld > 0),
             aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                shape = "boven mv"), size = 3, alpha = 0.5) +
  scale_shape(solid = FALSE) +
  ## non-clipping zoom
  coord_cartesian(ylim = c(-0.5, 0.1),
                  xlim = c(ymd("2006-01-01"), ymd("2021-01-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL, shape = NULL)
```

> **Samengevat**: DYLP101 en DYLP102 zijn oude meetreeksen waarvan de bruikbaarheid/betrouwbaarheid onduidelijk is. De filterdiepten van DYLP109 en DYLP223 liggen onder de 3 m, en ook gezien hun ligging is er weinig indicatie dat de kweldruk dermate is dat de gemeten stijghoogten sterk zouden afwijken van de effectieve grondwatertafel of overstromingsdiepte ter hoogte van de meetpunten? De stijghoogten boven maaiveld blijven bovendien steeds beperkt (max 9 cm).

## Oppervlaktewatermeetpunten
DYLS013? Samenhang met peilen boven maaiveld in grondwatermeetpunten DYLP109 en DYLP223?

## Opsplitsing naar raaien
Niet relevant?

# Komgrond Leibeek Oost (tot E40)

Deze komgrond ligt op de rechteroever van de Dijle en strekt zich uit van de Vaalbeek/Molenbeek in het zuiden tot aan de E40 in het noorden. De Leibeek doorsnijdt deze komgrond van zuid naar noord en ontspringt in de komgrond van de Doode Beemde (zie elders). Net na de Vijvers van Oud-Heverlee mondt ze uit in de Dijle. De komgrond wordt quasi integraal aangeduid als *effectief overstromingsgevoelig gebied*.
Ter hoogte van de Stationstraat in Korbeek-Dijle kan de komgrond evt. opgedeeld worden in een zuidelijk en een noordelijk deel. De oeverwallen van de Dijle in het noordelijk deel zijn minder uitgesproken dan in het zuidelijk deel.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Egenhoven in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package [`Watina`](https://inbo.github.io/watina/).

Selectie van de meetpunten in de komgrond van Egenhoven:
```{r}
komgr_leibeekO_N_loc_vec <- c("DYLR004", "DYLR005", "DYLP148", "DYLP117", "DYLP118", "DYLP119", "DYLP120", "DYLP140", "DYLP141", "DYLP142", "DYLP143", "DYLP144", "DYLP145", "DYLP146", "DYLP147", "DYLP149", "DYLP150", "DYLP151", "DYLP152", "DYLS005", "DYLS006", "DYLS007", "DYLS009", "DYLP121", "DYLP225", "DYLP116", "DYLP224", "DYLP112", "DYLP115", "DYLS014", "DYLP113", "DYLP171", "DYLS010", "DYLS015", "DYLS016")

komgr_leibeekO_Z_loc_vec <- c("DYLP107", "DYLP158", "DYLP160", "DYLP164", "DYLP165", "DYLS008", "DYLS011", "DYLP159", "DYLP108")

komgr_leibeekO_loc_vec <- data.frame(loc_code = c(komgr_leibeekO_N_loc_vec,
                                                   komgr_leibeekO_Z_loc_vec), stringsAsFactors = FALSE) %>%  
  mutate(NZ = ifelse(loc_code %in% komgr_leibeekO_N_loc_vec, "N", "Z")) %>% 
  arrange(loc_code)
```

```{r}
komgr_leibeekO_loc <- get_locs(watina,
                     loc_vec = komgr_leibeekO_loc_vec %>% select(loc_code) %>% pull(),
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_guess = TRUE,
                     filterdepth_na = TRUE,
                     filterdepth_range = c(0, 30))
komgr_leibeekO_loc %>% collect() %>% knitr::kable()
```

Voor slechts een beperkt aantal peilbuizen is de peilbuislengte, en dus ook de filterdiepte,  gekend.

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart komgrond leibeek O}
komgr_leibeekO_loc_sf <- komgr_leibeekO_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    data = komgr_leibeekO_loc_sf %>% filter(filterdepth < 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "red", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten < 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_leibeekO_loc_sf %>% filter(filterdepth >= 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "blue", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten >= 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_leibeekO_loc_sf %>% filter(is.na(filterdepth)),
    label = ~loc_code, fill = FALSE, weight = 3, color = "orange", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten diepte ongekend") %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten < 2.5 m", "Meetpunten >= 2.5 m", "Meetpunten diepte ongekend"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Spreiding qua filterdiepte van de peilbuizen, wetende dat voor het merendeel de filterdiepte onbekend is:

```{r histogram peilbuisdiepte leibeekO, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_leibeekO_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Er lijken geen peilbuiskoppels aanwezig te zijn in deze komgrond.

## Tijdreeksen van grondwatermeetpunten

Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`), die bovendien als betrouwbaar gelden (`is.na(PeilmetingCategorie) | PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")`).
```{r tijdreeks leibeekO}
komgr_leibeekO_tijdreeks <-
  komgr_leibeekO_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>%
  mutate(filterdiepte_01 = ifelse(is.na(filterdepth), "niet gekend", "gekend"),
         filterdiepte_clas = ifelse(filterdepth < 2.5, "< 2.5 m", ">= 2.5 m")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))
```

Onderstaande figuren geven de tijdreeksen voor de verschillende meetpunten met gemeten stijghoogten boven maaiveld, met onderscheid naar informatie over de filterdiepte (gekend/niet gekend, diep of ondiep).

Ten zuiden van Stationstraat:

```{r tijdreeks_leibeekO_plotZ, message=FALSE, warning=FALSE}
temp <- komgr_leibeekO_tijdreeks %>% 
  filter(mMaaiveld > 0 & loc_code %in% komgr_leibeekO_Z_loc_vec) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_leibeekO_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_01)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekO_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```

```{r tijdreeks_leibeekO_plotZ, message=FALSE, warning=FALSE}
temp <- komgr_leibeekO_tijdreeks %>% 
  filter(mMaaiveld > 0 & loc_code %in% komgr_leibeekO_Z_loc_vec) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_leibeekO_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_clas)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekO_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```

Ten noorden van Stationstraat:

```{r tijdreeks_leibeekO_plotZ, message=FALSE, warning=FALSE}
temp <- komgr_leibeekO_tijdreeks %>% 
  filter(mMaaiveld > 0 & loc_code %in% komgr_leibeekO_N_loc_vec) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_leibeekO_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_01)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekO_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```

```{r tijdreeks_leibeekO_plotZ, message=FALSE, warning=FALSE}
temp <- komgr_leibeekO_tijdreeks %>% 
  filter(mMaaiveld > 0 & loc_code %in% komgr_leibeekO_N_loc_vec) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_leibeekO_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_clas)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekO_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```

<!-- Hieruit komen een aantal zaken naar voren: -->

* vermoedelijk sterke kweldruk 
    * in DYLP107 en DYLP117: vanwege ligging net onderaan de steilrand van vallei --> hoge kweldruk met dus stijghoogten die hoger liggen dan effectief grondwaterpeil
    * DYLP171: zeer diepe filter
* sterke veranderingen in stijghoogten tussen verschillende meetperioden (na onderbreking van metingen):
    * DYLP171: zeer diepe filter --> stijghoogten komen niet overeen met grondwaterpeil; bovendien grote verandering in gemeten stijghoogten tussen 2010-2013 en vanaf 2017: vanwaar die grote sprong?
    * DYLP121: grote verandering in stijghoogten in 2000-2001 vs in 2006-2008: vanwaar die verandering? Zie ook DYLP171, want beide meetpunten liggen dicht bij elkaar langs de Leibeek, tussen de Dijle en de Vijvers van Oud-Heverlee; veranderingen in beheer van de Leibeek (ruiming, opstuwing, aantakking Dijle)?

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

In de komgrond Leibeek Oost werden echter geen metingen gedaan waaraan dit label werd toegekend. Voor de (handmatige) metingen met stijghoogten boven maaiveld hebben we dus geen uitsluitsel of op die momenten het omringend maaiveld ook effectief onder water stond.

### Kweldrukken
Er zijn geen peilbuiskoppels aanwezig in deze komgrond.

### Stijghoogten boven maaiveld

## Oppervlaktewatermeetpunten

## Opsplitsing naar raaien

# Komgrond Leibeek West (tot E40)

Deze komgrond ligt op de linkeroever van de Dijle, tussen de Stationstraat in Korbeek-Dijle in het zuiden tot de E40 snelweg in het noorden. De depressies rond Veeweide en Ormendaal worden ontwatert door de Leibeek die centraal in de komgrond in de Dijle uitmondt. De depressie rond Rotspoel (E40) ontwatert naar de komgrond van Egenhoven ten noorden van de E40 via een waterloop (Langestaart) die onder de E40 door stroomt (via pompstation?). Eigenlijk hoort het noordelijke stuk van deze komgrond dus eerder tot de komgrond van Egenhoven, maar de E40 zorgt wel voor een barrière.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Egenhoven in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package [`Watina`](https://inbo.github.io/watina/).

Selectie van de meetpunten in de komgrond van Egenhoven:

```{r}
komgr_leibeekW_loc <- get_locs(watina,
                     loc_vec = c("DYLP131", "DYLP134", "DYLP130", "DYLP133", "DYLP135", "DYLP153", "DYLP169", "DYLP178", "DYLP176", "DYLP177", "DYLP277", "DYLP132", "DYLP200"),
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_guess = TRUE,
                     filterdepth_na = TRUE,
                     filterdepth_range = c(0, 30))
komgr_leibeekW_loc %>% collect() %>% knitr::kable()
```

Voor net iets meer dan de helft van de (historische) peilbuizen is de peilbuislengte, en dus ook de filterdiepte, gekend. In 4 van de 7 peilbuizen met gekende filterdiepte, zit de filter meer dan 2.5 m onder maaiveld.
De meetpunten DYLP177 en DYLP277 vormen een peilbuiskoppel, hoewel de filterdiepten slechts ongeveer 1 m verschillen.

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven, met onderscheid naar filterdiepte.

```{r kaart komgrond leibeek west}
komgr_leibeekW_loc_sf <- komgr_leibeekW_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    data = komgr_leibeekW_loc_sf %>% filter(filterdepth < 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "red", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten < 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_leibeekW_loc_sf %>% filter(filterdepth >= 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "blue", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten >= 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_leibeekW_loc_sf %>% filter(is.na(filterdepth)),
    label = ~loc_code, fill = FALSE, weight = 3, color = "orange", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten diepte ongekend") %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten < 2.5 m", "Meetpunten >= 2.5 m", "Meetpunten diepte ongekend"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Spreiding qua filterdiepte van de peilbuizen, wetende dat voor de helft geen filterdiepte bekend is:

```{r histogram peilbuisdiepte leibeekW, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_leibeekW_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

## Tijdreeksen van grondwatermeetpunten
Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`), die bovendien als betrouwbaar gelden (`is.na(PeilmetingCategorie) | PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")`).
```{r tijdreeks leibeekW}
komgr_leibeekW_tijdreeks <-
  komgr_leibeekW_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>%
  mutate(filterdiepte_01 = ifelse(is.na(filterdepth), "niet gekend", "gekend"),
         filterdiepte_clas = ifelse(filterdepth < 2.5, "< 2.5 m", ">= 2.5 m")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   collect()
```

Onderstaande figuren geven de tijdreeksen voor de verschillende meetpunten, met onderscheid naar informatie over de filterdiepte (gekend/niet gekend, diep of ondiep).

```{r tijdreeks_leibeekW_plot, message=FALSE, warning=FALSE}
ggplot(komgr_leibeekW_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_01)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekW_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```
```{r tijdreeks_leibeekW_plot2, message=FALSE, warning=FALSE}
ggplot(komgr_leibeekW_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                linetype = filterdiepte_clas)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leibeekW_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom", legend.box = "vertical") +
  labs(x = "Datum", y = "m-mv", colour = "Meetpunt", linetype = "filterdiepte")
```

Hieruit komen een aantal zaken naar voren:

* voor de peilbuizen waarvan de filterdiepte niet gekend is, zijn de tijdreeksen allemaal oud (2000-2001) en bovendien zeer kort (minder dan één hydrologisch jaar)
* er zijn slechts drie meetpunten met een filterdiepte < 2.5 m; de tijdreeks van DYLP130 is bovendien erg kort, en de overige twee meetpunten (DYLP200 en DYLP132) liggen in dezelfde depressie (Rotspoel, langs E40)
* DYLP176 (diepe filter) vertoont in de periode 2002-2012 rare, niet-seizoensgebonden schommelingen en bovendien lijkt er een trend aanwezig die duidt op een globale toename van de stijghoogte in diezelfde periode. Heeft dit mogelijks te maken met een sterkere beïnvloeding van de grondwaterpeilen door de peilen van de Dijle dan in andere komgronden, of misschien met de nabijheid van de drinkwaterwinning die de freatische grondwaterlagen in het gebied aanboort, of nog een andere reden?
* in heel wat van deze tijdreeksen, die bovendien allemaal uit handmatige metingen bestaan, springen de gemeten stijghoogten regelmatig boven maaiveld; vanwege de grotere tijdspanne tussen opeenvolgende handmatige metingen is het evenwel mogelijk dat kortstondige overstromingen niet altijd (nauwkeurig) geregistreerd werden 
* DYLP200 vertoont geen globaal stijgende trend met onduidelijke seizoenale schommelingen, in tegenstelling tot de tijdreeksen van sommige andere meetpunten; de tijdreeks vertoont daarentegen duidelijke seizoenale schommelingen met buiten de zomerperiode bovendien stijghoogten die quasi continu tot boven het maaiveld reiken; die filterdiepte (2.45 m) doet alvast niet vermoeden dat hier sprake is van een kweldruk

Samengevat:
* De peilbuizen met *ondiepe filters* tonen aan dat de grondwaterpeilen voor het grootste deel van het jaar rond of boven het maaiveld schommelen (allen gesitueerd in de depressie van Rotspoel). Peilen boven maaiveld wijzen hier dus niet per se op overstromingen, maar eerder op grondwater dat (langdurig) boven maaiveld staat.
* De overige peilbuizen zijn allemaal uitgerust met *diepe filters*. Voor die peilbuizen is het onduidelijk in welke mate de gemeten stijghoogten overeenstemmen met het effectieve grondwaterpeil, dan wel dat ze een overschatting ervan geven.
* Het is belangrijk op te merken dat alle diepe peilbuizen (zeer) dicht tegen de pompinstallaties van de drinkwaterwinning van Korbeek-Dijle gelegen zijn.  

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

In de komgrond Leibeek West werden echter geen metingen gedaan waaraan dit label werd toegekend. Voor de (handmatige) metingen met stijghoogten boven maaiveld hebben we dus geen uitsluitsel of op die momenten het omringend maaiveld ook effectief onder water stond.

### Kweldruk en het verschil tussen stijghoogte en waterpeil

We bekijken hieronder de tijdreeksen van het reeds vermelde peilbuiskoppel DYLP177-DYLP277 (ondiep-diep) om te kijken of er sprake is van stijghoogteverschillen tussen de diepe en ondiepe peilbuizen binnen dit koppel, die dan kunnen duiden op een kweldruk. Bij een kweldruk is het alvast wenselijk om enkel de stijghoogten van de ondiepe peilbuis te gebruiken om een idee te krijgen van effectieve overstromingshoogten van het maaiveld. 

In dit geval zijn beide peilbuizen van het koppel echter uitgerust met een relatief diepe filter, nl. resp. op een diepte van 5 en 6 m. Aangezien de metingen aantonen dat de grondwatertafel ter hoogte van de meetpunten wellicht niet veel verder dan 1 m onder maaiveld zakt, zouden minder diepe peilbuizen in principe volstaan om de freatische grondwatertafel op te volgen. De gemeten stijghoogten in DYLP177 en DYLP277 zullen door de hogere drukken op grotere diepte dus alvast hoger liggen dan de effectieve grondwatertafel.

* DYLP177-DYLP277 (2 diepere peilbuizen)
```{r peilbuiskoppel1 leibeekW}
ggplot(komgr_leibeekW_tijdreeks %>% 
         filter(loc_code %in% c("DYLP177",
                                "DYLP277")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_leikbeekW_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```
Er is een verschil in stijghoogte vast te stellen. Het verschil is vooral uitgesproken bij hoge stijghoogten in beide peilbuizen (najaar-voorjaar). In de peilbuis met de diepere filter (DYLP277) worden dan stijghoogten opgemeten die tot meer dan 25 cm hoger liggen dan in de peilbuis met een ondiepere filter (DYLP177). In de periode 2005-2007 is dat dan weer niet het geval en blijven de stijghoogten van de diepere filter onder die van de ondiepere filter. Daarnaast zakt de stijghoogte van de diepe filter in verschillende jaren ook onder die van de ondiepe, met name op momenten dat de stijghoogten in beide peilbuizen op het laagste niveau staan (zomerperiode).
De stijghoogten reageren hier uiteraard op veranderingen in grondwatervoeding doorheen het jaar, maar vermoedelijk ook op de pompdebieten van de grondwaterwinning. De algehele stijging van de opgemeten peilen vanaf 2008 houdt hier wellicht ook verband mee.

### Stijghoogten boven maaiveld

De finale vraag is hier welke stijghoogten boven maaiveld indicatief zijn voor overstromingen ter hoogte van het maaiveld.

Het eerste probleem is dat:
* veel peilbuizen in deze komgrond uitgerust zijn met diepe filters (>2.5 m onder maaiveld) waardoor een mogelijke kweldruk aanleiding kan geven tot een overschatting van de effectieve grondwatertafel. Door gebrek aan peilbuiskoppels waarin de stijghoogten in peilbuizen met zowel een diepe als een ondiepe filter worden opgemeten, is het moeilijk om een kweldruk uit te sluiten. Het vermoeden is echter dat de stijghoogten van de huidige diepere peilbuizen niet zondermeer gebruik worden als indicatie voor overstromingen ter hoogte van het maaiveld
* de ondiepe peilbuizen wijzen op stijghoogten die een groot deel van het jaar boven maaiveld liggen. Deze peilbuizen liggen in een depressie (Rotspoel) waar de stijghoogten boven maaiveld wijzen op stagnerend grondwater, of beter gezegd grondwater dat langdurig boven het maaiveld staat. De peilen boven maaiveld wijzen hier dus niet zozeer op (tijdelijke) overstromingen die vooral door oppervlaktewater veroorzaakt worden.

## Oppervlaktewatermeetpunten

Om de waarschijnlijkheid te verifiëren dat ter hoogte van de meetpunten de gemeten stijghoogten boven maaiveld wijzen op effectieve overstromingen met oppervlaktewater, kunnen we visueel checken of deze metingen overeenkomen met momenten waarop het oppervlaktewaterpeil ook sterk toenam. Die momenten zijn veelal kortstondig van aard (pieken in de tijdreeksen).

In de komgrond van Leibeek West zijn er echter geen peilschalen aanwezig in de WATINA databank. Op [waterinfo.be](waterinfo.be) zijn er wel waterstandsmetingen beschikbaar voor de Dijle (t.h.v. Stationstraat in Korbeek-Dijle, dus aan zuidrand van komgrond; stationnr. L08_097) en op de waterloop Langestaart ter hoogte van het pompstation (Egenhoven/Zijloop C/pompstation, noordgrens van komgrond; stationnr. K08_010)

```{r}
# supported_variables("nl")

get_stations(variable_name = "waterstand") %>% 
  filter(grepl("Dijle", station_name) | grepl("Egenhoven", station_name)) %>% 
  arrange(station_no) %>% 
  knitr::kable()

```

Ligging van de meetstations:

```{r kaart meetstations egenhoven}

leaflet(get_stations(variable_name = "waterstand") %>% 
          filter(station_no %in% c("L08_097", "K08_010")) %>% 
          st_as_sf(coords = c("station_longitude", "station_latitude"))) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    label = ~paste0(station_name, "\n", station_no), fill = FALSE, weight = 3,
    color = "red", opacity = 1,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetstations") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetstations"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Nu moeten we nog kijken welke waterstandsvariabelen juist allemaal opgemeten worden per meetstation.

```{r}
get_variables("L08_097") %>% 
  filter(parametertype_name == "H") %>% 
  knitr::kable()
```
Omdat de grondwatermetingen ook een tijdsresolutie van 1 dag hebben (indien sondemetingen althans), en de maximale waarde wellicht het meest bepalend is voor de grondwaterstanden, kiezen we hier voor "DagMax" voor beide meetstations. Dat levert voor meetstation K08_010 `ts_id = 24940042` (Zijloop) op, en voor meetstation K08_097 `ts_id = 3840042` (Dijle). Op basis van deze id's vragen we de tijdreeksen op tussen 2000 en 2020.

Preview dataset:

```{r}
K08_010_timeseries <- get_timeseries_tsid("24940042", from = "2000-01-01", to = "2020-12-01") %>% 
  mutate(station_no = "K08_010_Langestaart")
K08_097_timeseries <- get_timeseries_tsid("3840042", from = "2000-01-01", to = "2020-12-01") %>% 
  mutate(station_no = "K08_097_Dijle")
K08_timeseries <- rbind(K08_010_timeseries, K08_097_timeseries)
head(K08_timeseries)
```
Tijdreeksen op basis van de maximale waterstanden per dag voor beide meetstations:

```{r}
ggplot(K08_timeseries) +
  geom_line(aes(Timestamp, Value, colour = factor(station_no, levels = c("K08_097_Dijle", "K08_010_Langestaart")))) +
  labs(colour = NULL, x = "Datum", y = "Waterstand (dagmaximum, mTAW)")
```
Peilen van de Dijle ter hoogte van meetstation K08_097, samen met de tijdreeksen van de grondwatermeetpunten met stijghoogten boven maaiveld:

```{r}
temp <- komgr_leibeekW_tijdreeks %>% 
  filter(mMaaiveld > 0
         # & filterdepth <= 2.5
         ) %>%
select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_leibeekW_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  # coord_cartesian(
  # xlim = c(ymd("2000-01-01"), ymd("2021-01-01")),
  # # ylim = c(25.5,28)
  # ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  geom_line(data = K08_timeseries %>% filter(station_no == "K08_097_Dijle"),
            aes(date(Timestamp), Value, 
                linetype = factor(station_no,
                                  levels = c("K08_097_Dijle",
                                             "K08_010_Langestaart"))),
            alpha = 0.25) +
  facet_grid(rows = vars(loc_code)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```

Noch voor de diepe, noch voor de ondiepe grondwatermeetpunten is er een duidelijke samenhang terug te vinden tussen de oppervlaktewaterpeilen van de Dijle en de stijghoogten ter hoogte van de grondwatermeetpunten.

Peilen van de waterloop Langestaart ter hoogte van meetstation K08_010, samen met de tijdreeksen van de grondwatermeetpunten; dit is enkel relevant voor de meetpunten DYLP200 en DYLP132:

```{r}
ggplot(komgr_leibeekW_tijdreeks %>% 
         filter(loc_code %in% c("DYLP200", "DYLP132"))) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  # coord_cartesian(
  # xlim = c(ymd("2000-01-01"), ymd("2021-01-01")),
  # # ylim = c(25.5,28)
  # ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  geom_line(data = K08_timeseries %>% filter(station_no == "K08_010_Langestaart"),
            aes(date(Timestamp), Value, 
                linetype = factor(station_no,
                                  levels = c("K08_097_Dijle",
                                             "K08_010_Langestaart"))),
            alpha = 0.25) +
  facet_grid(rows = vars(loc_code)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```

Ook op basis van deze figuur is er nauwelijks een interactie terug te vinden tussen de gemeten stijghoogten boven maaiveld enerzijds en de (pieken in) oppervlaktewaterstanden anderzijds. De afwezigheid van hoge pieken in de tijdreeksen met stijghoogten doet vermoeden dat er dus nauwelijks invloed is van de oppervlaktewaterstanden op de grondwaterstanden ter hoogte van DYLP132 en DYLP200. De pieken in oppervlaktewaterstanden dringen dus niet door tot bij de betreffende meetpunten vanwege fysieke barières of omdat het om te kortstondige pieken gaat die niet geregistreerd werden door de sondes in de grondwatermeetpunten.

## Opsplitsing naar raaien
Niet van toepassing

# Komgrond Egenhovenbos

Situering en samenhang met noordelijk deel van komgrond Leibeek West

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Egenhoven in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package [`Watina`](https://inbo.github.io/watina/).

Selectie van de meetpunten in de komgrond van Egenhoven:

```{r}
komgr_egenhoven_loc <- get_locs(watina,
                     loc_vec = c("DYLP125", "DYLP128", "DYLP168", "DYLP161", "DYLP162", "DYLP126", "DYLP127"),
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_guess = TRUE,
                     filterdepth_na = TRUE,
                     filterdepth_range = c(0, 30))
komgr_egenhoven_loc %>% collect() %>% knitr::kable()
```

Voor één van de peilbuizen is de peilbuislengte, en dus ook de filterdiepte, niet gekend.

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart komgrond egenhoven}
komgr_egenhoven_loc_sf <- komgr_egenhoven_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    data = komgr_egenhoven_loc_sf %>% filter(filterdepth < 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "red", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten < 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_egenhoven_loc_sf %>% filter(filterdepth >= 2.5),
    label = ~loc_code, fill = FALSE, weight = 3, color = "blue", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten >= 2.5 m") %>% 
  addCircleMarkers(
    data = komgr_egenhoven_loc_sf %>% filter(is.na(filterdepth)),
    label = ~loc_code, fill = FALSE, weight = 3, color = "orange", opacity = 0.5,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetpunten diepte ongekend") %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetpunten < 2.5 m", "Meetpunten >= 2.5 m", "Meetpunten diepte ongekend"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Spreiding qua filterdiepte van de peilbuizen, wetende dat voor de helft geen filterdiepte bekend is:

```{r histogram peilbuisdiepte egenhoven, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_egenhoven_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit de kaart en bovenstaande figuur leiden we af dat er 1 diepere (> 2.5 m diep) peilbuis is. Van één van de peilbuizen kennen we evenwel de peilbuislengte (en dus ook de filterdiepte) niet.
Hoewel ze op enkele meters van elkaar gelegen zijn, vormen peilbuizen DYLP161 en DYLP162 een koppel met resp. diepe en ondiepe filterdiepte.

## Tijdreeksen van grondwatermeetpunten
Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`), die bovendien als betrouwbaar gelden (`is.na(PeilmetingCategorie) | PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")`).
```{r tijdreeks egenhoven}
komgr_egenhoven_tijdreeks <-
  komgr_egenhoven_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & (is.na(PeilmetingCategorie) | 
                                            PeilmetingCategorieCode %in% c("SOUWA", "TBWWL"))) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   collect()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_egenhoven_plot, message=FALSE, warning=FALSE}
ggplot(komgr_egenhoven_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_egenhoven_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                # colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"),
  #                colour = loc_code)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Hieruit komen een aantal zaken naar voren:

* de stijghoogten komen weliswaar zeer kort, maar wel zeer hoog boven het maaiveld uit, met uitgesproken pieken; na te gaan of dit samengaat met piekdebieten in omliggende waterlopen, waaronder uiteraard de Dijle zelf (zie Oppervlaktewatermeetpunten) 
* de metingen concentreren zich vooral tussen 2010 en 2014; na 2014 zijn er enkel voor meetpunt DYLP126 nog metingen vanaf 2019; wat is hier de reden juist voor, en zijn er misschien nog ontbrekende meetgegevens? Voor DYLP127 staat er nog een meetreeks tussen sept 2016 en juli 2019 op "ingegeven" (dus nog niet gevalideerde meetgegevens; evenwel geen schijnbare rariteiten); onduidelijk of er voor DYLP161 en DYLP162 nog meetgegevens zouden zijn
* in vergelijking met de periode 2010-2014 lijken zowel de hoogste als laagste grondwaterstanden tot ongeveer een halve meter lager te liggen in 2019 en (deels) 2020; we beschikken enkel voor meetpunt DYLP126 over recente meetgegevens, maar de vraag is of dit een systematische grondwaterstandsdaling is door menselijk ingrijpen, dan wel een gevolg van enkele extreem droge jaren. De vraag is of dit ook tot uiting komt in de overige meetpunten waarvoor er geen recente meetgegevens voorhanden zijn
* peilbuiskoppel DYLP161-162 (diep-ondiep): hier lijkt alleszins sprake van een kweldruk; het koppel ligt dan ook aan de rand van de vallei, en de diepe peilbuis zit ongeveer 2 m dieper dan de ondiepe; de stijghoogte in de diepere peilbuis ligt systematisch ongeveer 40-45 cm hoger dan in de ondiepe peilbuis

### PeilMetingCategorie

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft of op het moment van opmeten het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). Tijdens deze metingen werd dus op het terrein met zekerheid vastgesteld dat het maaiveld/de peilbuis overstroomd werd.

Zoals uit de tijdreeksen hierboven al visueel kan opgemaakt worden, gaat het merendeel van de metingen om automatische sondemetingen. De hoge densiteit aan metingen (2/dag) en de vele kleine sprongen op korte tijd (dag/nacht) die zorgen voor een band eerder dan een lijn van punten, wijzen hierop. Aan automatische metingen worden bovenstaande labels niet toegekend omdat er geen terreinverificatie plaatsvindt op het moment dat de meting geregistreerd wordt (tenzij dan tijdens de sporadische, handmatige kalibratiemetingen). In de komgrond van Egenhoven werden geen manuele metingen geregistreerd met de vermelding dat het maaiveld of de peilbuis onder water stond op het moment van opmeting.

### Kweldrukken

Uit de metadata van de peilbuizen in de komgrond van Egenhovenbos blijkt dat de peilbuizen van de meetpunten DYLP161 en DYLP162 een peilbuiskoppel vormen, met DYLP161 als diepe en DULP162 als ondiepe peilbuis.

We bekijken hieronder de tijdreeksen van beide peilbuizen om te kijken of er sprake is van stijghoogteverschillen tussen beide, wat dan kan duiden op een kweldruk. Bij de aanwezigheid van een opwaartse kweldruk is het alvast wenselijk om enkel de stijghoogten van de ondiepe peilbuis te gebruiken om een idee te krijgen van effectieve overstromingshoogten van het maaiveld. Hoe ondieper de filter van een peilbuis, hoe beter de gemeten stijghoogten immers overeenkomen met de werkelijke grondwatertafel.

```{r peilbuiskoppel1 egenhovenbos}
ggplot(komgr_egenhoven_tijdreeks %>% 
         filter(loc_code %in% c("DYLP161",
                                "DYLP162")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                # linetype = MetingTypeNaam
                ), alpha = 0.5) +
  ## non-clipping zoom
  coord_cartesian(xlim = c(ymd("2010-01-01"), ymd("2014-07-01"))
                  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_egenhoven_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```
Uit bovenstaande figuur blijkt dat de stijghoogten bij diepe filter toch minstens een 20-tal cm hoger liggen

> **Samengevat**: selectie van peilbuizen met filterdiepte < 2.5 m (peilbuis met ongekende filterdiepte heeft geen stijghoogten boven maaiveld)

### Stijghoogten boven maaiveld

Als we enkel de peilbuizen beschouwen met filterdiepte < 2.5 m én (occasionele) stijghoogten boven maaiveld, dan houden we volgende tijdreeksen over:

```{r tijdreeks_egenhoven_taw1, message=FALSE, warning=FALSE}
temp <- komgr_egenhoven_tijdreeks %>% 
  filter(mMaaiveld > 0 & filterdepth <= 2.5) %>%
  # filter(loc_code %in% c("DYLP126", "DYLP127", "DYLP161", "DYLP162")) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_egenhoven_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  coord_cartesian(
  xlim = c(ymd("2006-01-01"), ymd("2021-01-01")),
  # ylim = c(25.5,28)
  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```
```{r tijdreeks_egenhoven_taw2, message=FALSE, warning=FALSE}
temp <- komgr_egenhoven_tijdreeks %>% 
  filter(mMaaiveld > 0 & filterdepth <= 2.5) %>%
  # filter(loc_code %in% c("DYLP126", "DYLP127", "DYLP161", "DYLP162")) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_egenhoven_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  coord_cartesian(
  xlim = c(ymd("2006-01-01"), ymd("2021-01-01")),
  # ylim = c(25.5,28)
  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  facet_grid(rows = vars(loc_code)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

> **Samengevat**: selectie van peilbuizen met filterdiepte < 2.5 m (peilbuis met ongekende filterdiepte heeft geen stijghoogten boven maaiveld) én gemeten stijghoogten boven maaiveld

## Oppervlaktewatermeetpunten

Volgens de WATINA databank lijken er geen peilschalen aanwezig te zijn in Egenhovenbos. Daarom raadplegen we de gegevens over oppervlaktewaterstanden via [Waterinfo.be](waterinfo.be).

We zoeken met trefwoord "Egenhoven" in de lijst met meetstations waar waterstanden opgemeten worden.

```{r}
# supported_variables("nl")

get_stations(variable_name = "waterstand") %>% 
  filter(grepl("Egenhoven", station_name)) %>% 
  arrange(station_no) %>% 
  knitr::kable()

```

Ligging van de meetstations:

```{r kaart meetstations egenhoven}

leaflet(get_stations(variable_name = "waterstand") %>% 
          filter(grepl("Egenhoven", station_name)) %>% 
          st_as_sf(coords = c("station_longitude", "station_latitude"))) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addCircleMarkers(
    label = ~paste0(station_name, "\n", station_no), fill = FALSE, weight = 3,
    color = "red", opacity = 1,
    labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                direction = "right", opacity = 0.5),
    group = "Meetstations") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "Ortho_VL_winter", "Cartoweb"),
    overlayGroups = c("Meetstations"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

De meetstations K08_011 en K08_012 lijken relevant. We selecteren de waterstanden stroomopwaarts de kunstwerken omdat die wellicht het best de waterstanden ter hoogte van de meetpunten benaderen (Hopw).

Nu moeten we nog kijken welke waterstandsvariabelen juist allemaal opgemeten worden per meetstation.

```{r}
get_variables("K08_012") %>% 
  filter(parametertype_name == "H" & grepl("Hopw", stationparameter_name)) %>% 
  knitr::kable()
```
Omdat de grondwatermetingen ook een tijdsresolutie van 1 dag hebben, en de maximale waarde wellicht het meest bepalend is voor de grondwaterstanden, kiezen we hier voor "DagMax" voor beide meetstations. Dat levert voor meetstation K08_011 `ts_id = 24980042` (Zijloop) op, en voor meetstation K08_012 `ts_id = 31429042` (Dijle). Op basis van deze id's vragen we de tijdreeksen op tussen 2000 en 2020.

Preview dataset:

```{r}
K08_011_timeseries <- get_timeseries_tsid("24980042", from = "2000-01-01", to = "2020-12-01") %>% 
  mutate(station_no = "K08_011_Langestaart")
K08_012_timeseries <- get_timeseries_tsid("31429042", from = "2000-01-01", to = "2020-12-01") %>% 
  mutate(station_no = "K08_012_Dijle")
K08_timeseries <- rbind(K08_011_timeseries, K08_012_timeseries)
head(K08_timeseries)
```
Tijdreeksen:

```{r}
ggplot(K08_timeseries %>% filter(Value > 20)) +
  geom_line(aes(Timestamp, Value, colour = factor(station_no, levels = c("K08_012_Dijle", "K08_011_Langestaart")))) +
  labs(colour = NULL)
```
Peilen van de Dijle ter hoogte van meetstation K08_012, samen met de tijdreeksen van de grondwatermeetpunten:

```{r}
temp <- komgr_egenhoven_tijdreeks %>% 
  filter(mMaaiveld > 0 & filterdepth <= 2.5) %>%
  # filter(loc_code %in% c("DYLP126", "DYLP127", "DYLP161", "DYLP162")) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_egenhoven_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  coord_cartesian(
  xlim = c(ymd("2006-01-01"), ymd("2021-01-01")),
  # ylim = c(25.5,28)
  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  geom_line(data = K08_timeseries %>% filter(Value > 20 & station_no == "K08_012_Dijle"),
            aes(date(Timestamp), Value, 
                linetype = factor(station_no,
                                  levels = c("K08_012_Dijle",
                                             "K08_011_Langestaart"))),
            alpha = 0.25) +
  facet_grid(rows = vars(loc_code)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```

Peilen van de loop Langestaart ter hoogte van meetstation K08_011, samen met de tijdreeksen van de grondwatermeetpunten:

```{r}
temp <- komgr_egenhoven_tijdreeks %>% 
  filter(mMaaiveld > 0 & filterdepth <= 2.5) %>%
  # filter(loc_code %in% c("DYLP126", "DYLP127", "DYLP161", "DYLP162")) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  pull()

ggplot(komgr_egenhoven_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                )) +
  ## non-clipping zoom
  coord_cartesian(
  xlim = c(ymd("2006-01-01"), ymd("2021-01-01")),
  # ylim = c(25.5,28)
  ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2006-01-01"), ymd("2020-12-31")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = mvTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)")
                ), linetype = "dashed"
            ) +
  geom_line(data = K08_timeseries %>% filter(Value > 20 & station_no == "K08_011_Langestaart"),
            aes(date(Timestamp), Value, 
                linetype = factor(station_no,
                                  levels = c("K08_012_Dijle",
                                             "K08_011_Langestaart"))),
            alpha = 0.25) +
  facet_grid(rows = vars(loc_code)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL, linetype = NULL)
```
De pieken in de grondwatermeetpunten komen mooi overeen met de pieken in de oppervlaktewaterpeilen van zowel de Dijle als de waterloop Langestaart. Na de aanleg van het stuw op de Dijle en zandvang in Egenhoven (2015?), lijkt die relatie echter verbroken te zijn. Er zijn evenwel te weinig grondwatermeetgegevens na 2014 om hierover een uitspraak te kunnen doen.

## Opsplitsing naar raaien

# Komgrond template
## Grondwatermeetpunten
## Tijdreeksen van grondwatermeetpunten
### PeilMetingCategorie
### Kweldrukken
### Stijghoogten boven maaiveld
## Oppervlaktewatermeetpunten
## Opsplitsing naar raaien
### Raai 1
#### Meetpunten:
#### Ligging:
#### Tijdreeksen:
#### Samenhang grond- en oppervlaktewaterpeilen

# Openstaande vragen

* hoe de peilmetingen met bepaalde categorieën uit de tijdreeksen van meetsondes verwijderen (twijfelachtig, meetartefacten, e.d.)? Die categorieën worden nu steeds weer overschreven bij hercompensatie/-kalibratie van drukmetingen, en kunnen er daardoor nu niet uitgefilterd worden. Enkel bij handmatige metingen zitten ze "ingebakken" ... Die categorieën zorgen nu voor uitschieters (zowel op- of neerwaarts) die mogelijks problemen geven als we ze als zodanig aanleveren ter kalibratie van de overstromingskaarten
* veel meetreeksen lijken te stoppen rond 2015; de oorzaak hiervan is niet geheel duidelijk: gaat het hier om meetpunten die nog wel bemeten worden, maar waarvoor de de metingen nog niet aangevuld werden in de databank, of werden er veel meetpunten effectief afgesloten in die periode?
* komgrond Doode Beemde: het is onduidelijk of ook de meetpunten ten oosten van de spoorwegbedding tot deze komgrond moeten gerekend worden. In principe lijkt dit stuk wel hydrologisch verbonden via de doorgang onder de spoorweg (verbindingsweggetje naar Waversebaan)
* DYLP008/016: is dit geen meetstation? Waarom werden de laatste jaren dan nog geen gevalideerde waarnemingen aangevuld in de databank?

```{r}
tbl(watina, "FactPeilMeting") %>% 
  select(starts_with("PeilmetingCategorie")) %>% 
  distinct() %>% 
  knitr::kable()
```


# Klad

```{r}
get_locs(watina, loc_type = c("P", "B"),
         loc_vec = "DYLP005",
         # area_codes = "DYL",
         obswells = TRUE
         ) %>% 
  collect()
```
```{r kaartje}
get_locs(watina,
         loc_vec = c("DYLP080", "DYLP081", "DYLS102", "DYLS002"),
         loc_type = c("P", "B", "S"),
         ) %>%  
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326) %>% 
  leaflet() %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addWMSTiles("https://geoservices.informatievlaanderen.be/raadpleegdiensten/omwrgbmrvl/wms?",
              layers = "Ortho",
              options = WMSTileOptions(format = "image/png", transparant = TRUE),
              group = "Ortho_VL_winter") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75),
             group = "Peilschalen") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "CartoWeb", "Ortho_VL_winter"),
    overlayGroups = "Peilschalen",
    options = layersControlOptions(collapsed = TRUE)
  )
```

```{r tijdreeks meetpunt mTAW, warning = FALSE}
get_locs(watina,
         loc_vec = c("DYLP023"),
         loc_type = c("P", "B", "S"),
         filterdepth_guess = TRUE,
         filterdepth_na = TRUE,
         filterdepth_range = c(0, 30)
         ) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                )
            ) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = soilsurf_ost,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                )
            ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

```{r tijdreeks meetpunt m-mv}
get_locs(watina,
         loc_vec = c("DYLP200", "DYLP277", "DYLP130", "DYLP178"),
         loc_type = c("P", "B"),
         filterdepth_guess = TRUE,
         filterdepth_na = TRUE,
         filterdepth_range = c(0, 30)
         ) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD" & is.na(PeilmetingCategorie)) %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_hline(yintercept = 0, colour = "black") +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code,
                # colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                ),
            ) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2010-09-01"), ymd("2011-02-01"))) +
  # geom_point(aes(x = date(Datum),
  #               y = mMaaiveld,
  #               # colour = loc_code,
  #               colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
  #               )) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```
```{r tijdreeks meetpunt m-mv}
get_locs(watina,
         loc_vec = c("DYLP023", "DYLP063", "DYLP056"),
         loc_type = c("P", "B"),
         filterdepth_guess = TRUE,
         filterdepth_na = TRUE,
         filterdepth_range = c(0, 30)
         ) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_hline(yintercept = 0, colour = "black") +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                # colour = loc_code,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                ),
            ) +
  ## non-clipping zoom
  coord_cartesian(xlim = c(ymd("2010-09-01"), ymd("2011-02-01"))) +
  # geom_point(aes(x = date(Datum),
  #               y = mMaaiveld,
  #               # colour = loc_code,
  #               colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
  #               )) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

```{r tijdreeks peilpunt mTAW, warning = FALSE}
get_locs(watina,
         loc_vec = c("DYLP005"),
         loc_type = c("P", "B", "S"),
         filterdepth_guess = TRUE,
         filterdepth_na = TRUE,
         filterdepth_range = c(0, 30),
         obswells = TRUE
         ) %>%
  inner_join(tbl(watina, "DimPeilpunt") %>% 
               select(PeilpuntWID, PeilpuntCode),
             by = c("obswell_code" = "PeilpuntCode")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID", "PeilpuntWID" = "PeilpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                # colour = loc_code,
                colour = obswell_code,
                # colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                )
            ) +
  ## non-clipping zoom
  # coord_cartesian(
  #   xlim = c(ymd("2007-01-01"), ymd("2021-01-01")),
  #   ylim = c(27, 27.5)
  # ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_line(aes(x = date(Datum),
                y = soilsurf_ost,
                # colour = loc_code,
                colour = obswell_code,
                # colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)")
                )
            ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

```{r}
tbl(watina, "FactPeilMeting") %>%
  colnames()
```

```{r}
tbl(watina, "FactPeilMeting") %>%
  select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
  distinct() %>%
  knitr::kable()
```

```{r}
komgr_doodebeemde_tijdreeks %>%
  select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
  distinct() %>%
  knitr::kable()
```


```{r}
tbl(watina, "FactPeilMeting") %>%
  select(PeilmetingStatusCode, PeilmetingStatus) %>%
  distinct() %>%
  knitr::kable()
```

```{r}
DBI::dbDisconnect(watina)
```

