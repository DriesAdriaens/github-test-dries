---
title: "Dataset validatie overstromingen - Dijle"
author: "Dries Adriaens"
date: "26-10-2020"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(watina)
library(ggplot2)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(sf)
library(leaflet)
```

```{r connection}
watina <- connect_watina()
# library(inbodb)
# con <- connect_inbo_dbase("D0025_00_Watina")
```

# Doelstelling

Voor het project Future Floodplains worden de overstromingen in de alluviale vallei van de Dijle gemodelleerd (werkpakket 1, KULeuven). Voor de validatie van de overstromingskaarten voor de actuele toestand is er nood aan effectief gemeten waterstanden tijdens overstromingen. De vraag is of er op basis van de grondwatermeetpunten (en evt. oppervlaktewatermeetpunten) uit de WATINA databank dergelijke meetgegevens op een betrouwbare manier aangeleverd kunnen worden.

Onderstaand document verkent welke gegegens eventueel in aanmerking komen als dataset ter validatie van de overstromingskaarten.

# Aanpak

* selectie grondwatermeetpunten
* kijken of meetwaarden effectief overeenstemmen met reële waterpeilen boven maaiveld
  + gebruik maken van manuele metingen met specifieke labels (zgn. peilmetingcategorieën) die wijzen op effectieve overstromingen
  + uitsluiten van diepere peilbuizen waar een eventuele kweldruk tot peilen boven maaiveld kan leiden die niet overeenstemmen met waterpeilen tijdens overstromingen
  + checken van locatie van peilbuizen; meer kans op kweldruk aan de steilrand van de vallei
* groeperen van meetpunten in relevante raaien, veelal dwars georiënteerd op vallei * eventueel relatie bekijken met aanwezige peilmetingen van oppervlaktewater (peilschalen)

We bekijken dit per komgrond.

# Komgrond Neerijse

Figuur invoegen? Of blijkt dat uit kaartjes met grondwatermeetpunten hieronder?

Het gaat hier om de komgrond ten westen van de Dijle ter hoogte van Neerijse, meer bepaald tussen de Neerijsebaan in het zuiden en de samenvloeiing van IJse en Dijle in het noorden. Deze komgrond wordt afgewaterd door de Leigracht die het gebied van zuid naar noord doormidden snijdt. De waterberging van deze komgrond wordt voornamelijk aangesproken door opstuwing van de Leigracht via de monding van de Ijse bij hoogwaterpeilen in de Dijle. De mate van opstuwing kan gestuurd worden via schotten op het stuw tussen Leigracht en Ijse.

## Grondwatermeetpunten

We vragen alle meetpunten op van het type "peilbuis" (peilpuntcategorie met code "P" of "B") die gelegen zijn in de komgrond van Neerijse in de vallei van de Dijle. De ruimtelijke selectie gebeurt ad hoc op basis van expertkennis in GIS. De metadata van deze punten wordt vervolgens opgevraagd met behulp van het R-package `Watina`.

Selectie van de meetpunten:

```{r meetpunten}
komgr_neerijse_loc_vec <- c("DYLP137", "DYLP105", "DYLP088", "DYLB028", "DYLB005", "DYLB080", "DYLB073", "DYLB072", "DYLB071", "DYLB065", "DYLP202", "DYLP204", "DYLP203", "DYLP021", "DYLP020", "DYLP034", "DYLP087", "DYLP086", "DYLP083", "DYLP082", "DYLP081", "DYLP095", "DYLP090", "DYLP089", "DYLP104", "DYLP098", "DYLP066", "DYLP065", "DYLP064", "DYLP080", "DYLP073", "DYLP072", "DYLP071", "DYLP070", "DYLP174", "DYLP170", "DYLP084", "DYLP028", "DYLP085", "DYLP005", "DYLP099", "DYLP047", "DYLP029")

komgr_neerijse_loc <- get_locs(watina,
                     loc_vec = komgr_neerijse_loc_vec,
                     loc_type = c("P", "B"),
                     loc_validity = c("VLD", "ENT"),
                     filterdepth_range = c(0, 30))
komgr_neerijse_loc %>% collect() %>% knitr::kable()
```

De ligging van deze grondwatermeetpunten wordt in onderstaande figuur weergegeven.

```{r kaart_raai_1}
komgr_neerijse_loc_sf <- komgr_neerijse_loc %>%
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326)

leaflet(data = komgr_neerijse_loc_sf) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Tijdreeksen van grondwatermeetpunten

Voor de geselecteerde grondwatermeetpunten vragen we de gevalideerde peilmetingen op (`PeilmetingStatusCode == "VLD"`).

```{r tijdreeks neerijse}
komgr_neerijse_tijdreeks <-
  komgr_neerijse_loc %>%
  # filter(filterdepth <= 3) %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

# tbl(watina, "FactPeilMeting") %>%
#   select(PeilmetingCategorieCode, PeilmetingCategorie) %>%
#   distinct() %>%
#   knitr::kable()
```

Onderstaande figuur geeft de tijdreeksen voor de verschillende meetpunten.

```{r tijdreeks_plot, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

Hieruit komen een aantal zaken naar voren:

* de duur van de tijdreeksen varieert uiteraard per meetpunt. Niet alle meetpunten worden/werden even lang bemeten
* sinds 1998 lijken de tijdreeksen meer frequent het maaiveld te overschrijden, wat kan wijzen op meer frequente overstromingen; de veelheid aan meetpunten maakt het in de figuur moeilijk om te zien of
* oudere metingen gebeurden veelal manueel; pas later werden de automatische meetsondes geïntroduceerd, die het voordeel hebben dat ze elke dag 2 metingen registreren en daardoor beter in staat zijn tijdelijke overstromingen te detecteren dan met manuele metingen, die in het beste geval om de 14 dagen gebeuren
* veel meetreeksen stoppen rond 2015; de oorzaak hiervan is niet geheel duidelijk: gaat het hier om meetpunten die nog wel bemeten worden, maar waarvoor de de metingen nog niet aangevuld werden in de databank, of werden er veel meetpunten effectief afgesloten in die periode?

We kunnen uit deze lijst de meetpunten selecteren met peilen boven maaiveld. Dat levert onderstaande subset op:

```{r meetpunten met peilen boven maaiveld}
komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

```{r boven maaiveld}
aantal <- komgr_neerijse_tijdreeks %>% 
  filter(mMaaiveld >= 0) %>% 
  select(loc_code) %>% 
  distinct() %>% 
  count() %>% 
  collect() %>% 
  .$n
```

Het gaat dan om nog `r aantal` van de `r length(komgr_neerijse_loc_vec)` meetpunten in de komgrond van Neerijse. In veel van de meetpunten liggen de meetwaarden van het grondwaterpeil (stijghoogten eigenlijk) dus minstens één of meerdere keren in het jaar boven het maaiveld.

### Peilmeting met labels die wijzen op effectieve overstromingen

Aan sommige manuele metingen (handmetingen dan wel kalibratiemetingen) werd expliciet een bepaald label (peilmetingcategorie) toegekend dat aangeeft dat het "maaiveld onder water" stond (code "SOUWA"), dan wel dat de "peilbuis onder water stond" (code "TBWWL"). De meetpunten met dergelijke metingen zijn de volgende:

```{r maaiveld overstroomd}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code) %>% 
  distinct() %>%
  inner_join(komgr_neerijse_loc, by = "loc_code") %>% 
  knitr::kable()
```

Dat zijn er bijzonder weinig. Voor de overige meetpunten met peilen boven maaiveld, is er dus geen zekerheid over het feit dat de watertafel effectief boven maaiveld stond op het moment van opmeting, en er dus effectief sprake is van een overstroming, dan wel dat er (tijdelijk) een hogere/verhoogde kweldruk aanwezig is.

De tijdreeksen voor de meetpunten met bovengenoemde peilmetingcategorieën zitten in onderstaande figuur, met aanduiding van de betreffende metingen.

```{r maaiveld overstroomd tijdreeks}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = loc_code)) +
  ## non-clipping zoom
  # coord_cartesian(
  #   ylim = c(-1, 0.1),
  #   xlim = c(ymd("2013-01-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld)) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

De betreffende metingen lijken sterk geclusterd in de tijd. Wat meer ingezoomd op de periode met deze metingen levert dat onderstaande figuur, met opsplitsing van de twee verschillende peilmetingcategorieën.

```{r "maaiveld overstroomd tijdreeks ingezoomd"}
temp <- komgr_neerijse_tijdreeks %>% 
                  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
                  select(loc_code) %>% 
                  distinct() %>% 
                  pull()

ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% temp)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"))) +
  ## non-clipping zoom
  coord_cartesian(
  #   ylim = c(-1, 0.1),
    xlim = c(ymd("2013-07-01"), ymd("2015-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                 shape = PeilmetingCategorie),
             size = 3) +
  scale_shape(solid = FALSE) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

Enkele opmerkingen bij bovenstaande figuur:

* Het is opmerkelijk dat heel wat van de peilmetingen met categorie "maaiveld onder water" toch grondwaterpeilen aangeven ónder maaiveld (tot > 5 cm soms) terwijl je hier toch net peilen bóven maaiveld zou verwachten. Mogelijks wijst dat erop dat het overstromingswater van elders afkomstig is (oppervlaktewater dus), en de peilen van oppervlakte- en grondwater -alvast tijdelijk- niet altijd overeenstemmen?
* De periode met beide peilmetingcategorieën is uitgesproken kort, net zoals het aantal meetpunten met dergelijke metingen
* DYLP047 en DYLP099 zijn resp. een diepe en ondiepe peilbuis op eenzelfde locatie. Het verschil in stijghoogte loopt in de winterperiode op tot meer dan 25 cm. Die vaststelling wijst alvast op een aanzienlijke kweldruk. De diepere peilbuis (DYLP047) geeft dus alvast niet de stand van de werkelijke watertafel weer en de peilen boven maaiveld wijzen dus zeker niet altijd op een overstroming. De metingen uit de tijdreeks van de ondiepe peilbuis van meetpunt DYLP099 zijn wellicht beter geschikt om dergelijke events aan te tonen. Helaas werd voor beide meetpunten enkel aan de allerlaatste meetwaarden de categorie "maaiveld onder water" toegekend (2019; zie onderstaande tabel) ...

```{r peilmetingen SOUWA TBWWL}
komgr_neerijse_tijdreeks %>% 
  filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")) %>% 
  select(loc_code, obswell_state, Datum, mMaaiveld, PeilmetingCategorie, PeilmetingCategorieCode) %>% 
  knitr::kable()
```

### Kweldruk en het verschil tussen stijghoogte en waterpeil

Uit de voorgaande tijdreeksen van een zgn. peilbuiskoppel (peilbuizen met verschillende filterdiepte op eenzelfde locatie, bv. DYLP047-099) blijkt alvast dat de peilen die er gemeten worden afhankelijk zijn van de filterdiepte. Hoe dieper de filter van een peilbuis, hoe groter de kans dat de gemeten peilen in de buis (stijghoogten) hoger liggen dan in een peilbuis met een filter op geringere diepte. De druk in diepere grondwaterlagen ligt immers veelal hoger. Dat zorgt voor een opwaartse druk en dito beweging van het grondwater. Als de stijghoogten hoger liggen in de diepe dan in de ondiepe peilbuis binnen een peilbuiskoppel, dan spreken we van kwel(druk).

Een stijghoogte boven maaiveld betekent echter niet dat het (grond)waterpeil zich ook boven maaiveld bevindt. Grondwater kan lateraal wegvloeien terwijl het onder het maaiveld blijft en/of kan het gedraineerd worden van zodra het aan de oppervlakte komt, via greppels en grachten. Hoe dan ook zullen -althans in het grondwatersysteem van de Dijlevallei- de peilen in ondiepe peilbuizen de werkelijke grondwatertafel beter benaderen dan die van diepe peilbuizen.

Van eventuele peilbuiskoppels selecteren we dus best de meest ondiepe peilbuis om peilen te selecteren die kunnen wijzen op een effectieve overstroming van het maaiveld.

We kunnen dus best checken of het verschil in stijghoogte ook terug te vinden is bij andere diepe(re) peilbuizen of peilbuiskoppels. Hiervoor kijken we eerst naar de verdeling qua filterdiepten op basis van al de aanwezige peilbuizen:

```{r histogram peilbuisdiepte, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE}
komgr_neerijse_loc %>% 
  ggplot() +
  geom_histogram(aes(x = filterdepth))
```

Uit bovenstaande figuur kunnen we dan kiezen om alle peilbuizen dieper dan 3 m als "diep" te beschouwen. Het gaat om deze peilbuizen:

```{r diepe peilbuizen}
komgr_neerijse_loc %>% 
  filter(filterdepth >= 3) %>% 
  knitr::kable()
```

Deze diepe peilbuizen staan afgebeeld op onderstaand kaartje.

```{r kaart diepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Vervolgens kijken we of bij elk van de diepere peilbuizen ook een ondiepe peilbuis zit, die samen een zgn. "peilbuiskoppel" vormen. Voor die koppels kunnen we dan kijken of er sprake is van een stijghoogteverschil dat kan wijzen op een de aanwezigheid van een kweldruk.

Uit onderstaand kaartje (diepe peilbuizen in blauw, ondiepe in rood) blijkt dat er voor de 3 diepere peilbuizen die starten met DYLP20* geen ondiepe tegenhanger aanwezig is. Dat is wel zo voor DYLP047, DYLP095 en DYLP170. Die laatste vormen dus met hun ondiepe tegenhangers, resp. DYLP099, DYLP098 en DYLP174, telkens een peilbuiskoppel.

```{r kaart diepe en ondiepe peilbuizen}
leaflet() %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3),
                   label = komgr_neerijse_loc_sf %>% 
                     filter(filterdepth >= 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>% 
  addCircleMarkers(data = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3),
                   label = komgr_neerijse_loc_sf %>%
                     filter(filterdepth < 3) %>% 
                     .$loc_code,
                   fill = FALSE, weight = 3, color = "red",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 0.75)) %>%
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

Voor deze punten bekijken we de tijdreeksen per peilbuiskoppel (diep-ondiep).

Koppel DYLP047-DYLP099:

```{r peilbuiskoppel1}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP047",
                                "DYLP099")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP095-DYLP098:

```{r peilbuiskoppel2}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP095",
                                "DYLP098")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Koppel DYLP170-DYLP174:

```{r peilbuiskoppel3}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP170",
                                "DYLP174")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
  
```

Uit bovenstaande figuren blijkt dat de stijghoogten in de diepere buizen systematisch minstens 20 cm hoger liggen dan in de ondiepe buizen van de peilbuiskoppels. Het verschil is het grootst voor de koppels DYLP170-DYLP174 en DYLP095-DYLP098, met verschillen die tot 50 cm bedragen. Voor het koppel DYLP047-DYLP099 liggen de verschillen lager, maar schommelen toch nog steeds rond de 20 cm.
Daarnaast is het aannemelijk dat ook voor de diepere peilbuizen zónder ondiepe tegenhanger (DYLP2*) de gemeten peilen (stijghoogten) niet overeen zullen stemmen met de grondwatertafel. Hun tijdreeksen staan hieronder afgebeeld.

```{r tijdreeksen diepe peilbuizen buiten peilbuiskoppels}
ggplot(komgr_neerijse_tijdreeks %>% 
         filter(loc_code %in% c("DYLP202", "DYLP203", "DYLP204")) %>% 
         inner_join(tbl(watina, "DimMetingType"), by = "MetingTypeWID")) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(filterdepth,1), " m-mv)"),
                linetype = MetingTypeNaam)) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"), legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL) 
```

Enkel voor DYLP203 werden peilen boven maaiveld gemeten. Het is twijfelachtig of die metingen overeenstemmen met effectieve overstromingen van het maaiveld. Naast het feit dat het om een diepe peilbuis gaat, kan ook de locatie aan de (steil)rand van de vallei aanleiding geven tot een verhoogde kweldruk waardoor de gemeten stijghoogte nog extra kan afwijken van de effectieve grondwatertafel.

We kunnen hier alvast besluiten dat het niet raadzaam is om de diepere peilbuizen te gebruiken om overstromingsdiepten te kalibreren. We verwijderen ze daarom uit de selectie.

De figuur met de tijdreeksen van de overblijvende meetpunten staat hieronder weergegeven (enkel ondiepe meetpunten met filterdiepte <= 3 m).

```{r tijdreeks_plot, message=FALSE, warning=FALSE}
komgr_neerijse_tijdreeks_plot <- ggplot(komgr_neerijse_tijdreeks %>% 
                                          filter(filterdepth <= 3)) +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(ylim = c(-1, 0.1),
  #                 xlim = c(ymd("2018-01-01"), ymd("2021-01-01"))
  #                 ) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_point(data = komgr_neerijse_tijdreeks %>% 
               filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
             aes(x = date(Datum),
                 y = mMaaiveld,
                 colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
  
komgr_neerijse_tijdreeks_plot
```

## Oppervlaktewatermeetpunten

Voor de komgrond van Neerijse beschikken we over 2 peilschalen die de oppervlaktewaterpeilen van de Dijle en de Leigracht meten (zie onderstaand kaartje). De peilschaal op de Dijle ter hoogte van de Reigerstraat wordt evenwel niet langer bemeten.

* DYLS001 (Dijle)
* DYLS102 (Leigracht)

```{r oppervlaktewatermeetpunt komgr neerijse}
komgr_neerijse_loc_opp <- get_locs(watina,
                                   loc_vec = c("DYLS001", "DYLS102"),
                                   loc_type = "S")

komgr_neerijse_loc_opp %>% collect() %>% knitr::kable()
```

```{r kaart peilschalen komgrond neerijse}
leaflet(data = get_locs(watina, loc_vec = c("DYLS001", "DYLS102"), loc_type = "S") %>% 
          collect() %>% 
          st_as_sf(coords = c("x","y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>%
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE)
  )
```

```{r oppervlaktewatermeetpunt komgr neerijse tijdreeks}
komgr_neerijse_tijdreeks_opp <-
  komgr_neerijse_loc_opp %>% 
  rename(mvTAW = soilsurf_ost) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID"))

ggplot(komgr_neerijse_tijdreeks_opp) +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code)) +
  ## non-clipping zoom
  coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  # geom_point(data = komgr_neerijse_tijdreeks %>% 
  #              filter(PeilmetingCategorieCode %in% c("SOUWA", "TBWWL")),
  #            aes(x = date(Datum),
  #                y = mMaaiveld,
  #                colour = paste0(loc_code, " (", round(mvTAW,2), " mTAW)"))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "bottom") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```

Samenhang met grondwaterstanden, en meer specifiek met grondwaterstanden boven maaiveld?

## Opsplitsing naar raaien?
Met samenhang oppervlakte- en grondwater

### Raai 1

Transversaal

```{r}
komgr_neerijse_raai1_locs <- get_locs(
  watina, 
  loc_vec = c("DYLP043","DYLP064","DYLP086","DYLP087","DYLP085", "DYLP104"),
  filterdepth_range = c(0,3))

komgr_neerijse_raai1_locs %>% collect()
```
```{r}
leaflet(komgr_neerijse_raai1_locs %>% 
          collect() %>% 
          st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
          st_transform(crs = 4326)) %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code,
                   fill = FALSE, weight = 3, color = "blue",
                   labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                               direction = "right", opacity = 1)) %>% 
  addMiniMap(toggleDisplay = TRUE, zoomLevelOffset = -5, minimized = TRUE) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "Cartoweb"),
    overlayGroups = "Meetpunten",
    options = layersControlOptions(collapsed = FALSE))
```

```{r}
komgr_neerijse_raai1_locs %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mMaaiveld,
                colour = paste0(loc_code, " (", round(soilsurf_ost,2), " mTAW)"))) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  geom_hline(yintercept = 0, colour = "black", size = 1, linetype = "dotted") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "m-mv", colour = NULL)
```

DYLP085 samen plotten met peil van Leigracht (DYLS102)

```{r}
get_locs(watina, loc_vec = c("DYLP085", "DYLS102"), loc_type = c("P", "B", "S")) %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(PeilmetingStatusCode == "VLD") %>% 
  inner_join(tbl(watina, "DimTijd"), by = c("TijdWID" = "DatumWID")) %>% 
  ggplot() +
  geom_line(aes(x = date(Datum),
                y = mTAW,
                colour = loc_code), alpha = 0.75) +
  ## non-clipping zoom
  # coord_cartesian(xlim = c(ymd("2007-01-01"), ymd("2021-01-01"))) +
  scale_x_date(date_breaks = "year", date_labels = "%Y") +
  ## clipping zoom
  # xlim(ymd("2013-07-01"), ymd("2015-01-01")) +
  # ylim(-1, 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor.x = element_line(linetype = "dashed"),
        legend.position = "right") +
  labs(x = "Datum", y = "mTAW", colour = NULL)
```


```{r include = FALSE}
get_locs(watina, loc_vec = "DYLP085") %>% 
  inner_join(tbl(watina, "FactPeilMeting"),
             by = c("loc_wid" = "MeetpuntWID")) %>% 
  filter(TijdWID < 20170101 & TijdWID > 20161101) %>% 
  collect()
```


### Raai 2

# Andere komgronden?

## Grondwatermeetpunten

## Tijdreeks grondwatermeetpunten

## Oppervlaktewatermeetpunten

# Klad

```{r}
dyl_locs_opp <- get_locs(watina, loc_type = "S", area_codes = "DYL")

dyl_locs_opp %>% 
  collect()
```
```{r}
dyl_locs_opp %>% 
  collect() %>% 
  st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
  st_transform(crs = 4326) %>% 
  leaflet() %>% 
  addWMSTiles("https://wms.ngi.be/cartoweb/1/service?", layers = "cartoweb_topo",
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Cartoweb") %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI WorldImagery") %>% 
  addCircleMarkers(label = ~loc_code, fill = FALSE, weight = 3, color = "red",
             labelOptions = labelOptions(noHide = TRUE, textOnly = FALSE,
                                         direction = "right", opacity = 0.75),
             group = "Peilschalen") %>% 
  addMiniMap(toggleDisplay = TRUE,zoomLevelOffset = -5) %>% 
  addLayersControl(
    baseGroups = c("OSM", "ESRI WorldImagery", "CartoWeb"),
    overlayGroups = "Peilschalen",
    options = layersControlOptions(collapsed = TRUE)
  )
```

